import sys
import unittest
from unittest.mock import MagicMock, mock_open, patch

# Mock boto3 before any imports that might use it
sys.modules["boto3"] = MagicMock()

# Patch get_secret_value_from_secret_manager to return a test API key
with patch(
    "ragent.aws.secrets_manager.envs.get_secret_value_from_secret_manager",
    return_value="test-api-key",
):
    from ragent.transcribe.openai import WhisperTranscriber
    from ragent.transcribe.openai.app import (
        DEFAULT_HALLUCINATION_KEYWORDS,
        DEFAULT_HALLUCINATION_PHRASES,
    )

TEST_TRANSCRIPT = "This is a test transcription"
TEST_LANGUAGE = "en"
TEST_DURATION = 5.5


class MockTranscriptionResponse:
    """Mock response object from OpenAI Whisper API"""

    def __init__(
        self, text=TEST_TRANSCRIPT, language=TEST_LANGUAGE, duration=None, words=None
    ):
        self.text = text
        self.language = language
        self.duration = duration
        self.words = words


class WhisperTranscriberInitializationTests(unittest.TestCase):
    def setUp(self):
        self.api_key = "test-api-key"
        self.model = "whisper-1"
        self.min_audio_size = 1024
        self.min_transcript_length = 3
        self.hallucination_check_enabled = True

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_basic(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        transcriber = WhisperTranscriber(
            api_key=self.api_key,
            model=self.model,
            min_audio_size=self.min_audio_size,
            min_transcript_length=self.min_transcript_length,
            hallucination_check_enabled=self.hallucination_check_enabled,
        )

        self.assertEqual(transcriber.api_key, self.api_key)
        self.assertEqual(transcriber.model, self.model)
        self.assertEqual(transcriber.min_audio_size, self.min_audio_size)
        self.assertEqual(transcriber.min_transcript_length, self.min_transcript_length)
        self.assertEqual(
            transcriber.hallucination_check_enabled, self.hallucination_check_enabled
        )
        mock_openai.assert_called_once_with(api_key=self.api_key)

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_with_custom_hallucination_phrases(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        custom_phrases = ["custom phrase 1", "custom phrase 2"]
        transcriber = WhisperTranscriber(
            api_key=self.api_key, hallucination_phrases=custom_phrases
        )

        self.assertEqual(transcriber.hallucination_phrases, custom_phrases)

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_with_custom_hallucination_keywords(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        custom_keywords = ["custom keyword 1", "custom keyword 2"]
        transcriber = WhisperTranscriber(
            api_key=self.api_key, hallucination_keywords=custom_keywords
        )

        self.assertEqual(transcriber.hallucination_keywords, custom_keywords)

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_with_hallucination_check_disabled(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        transcriber = WhisperTranscriber(
            api_key=self.api_key, hallucination_check_enabled=False
        )

        self.assertFalse(transcriber.hallucination_check_enabled)

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_default_hallucination_phrases(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        transcriber = WhisperTranscriber(api_key=self.api_key)

        self.assertEqual(
            transcriber.hallucination_phrases, DEFAULT_HALLUCINATION_PHRASES
        )

    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_init_default_hallucination_keywords(self, mock_openai):
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        transcriber = WhisperTranscriber(api_key=self.api_key)

        self.assertEqual(
            transcriber.hallucination_keywords, DEFAULT_HALLUCINATION_KEYWORDS
        )


class WhisperTranscriberTranscribeTests(unittest.TestCase):
    def setUp(self):
        self.api_key = "test-api-key"
        self.model = "whisper-1"
        self.audio_data = (
            b"fake audio data" * 100
        )  # Make it large enough to pass validation
        self.filename = "test_audio.webm"
        self.content_type = "audio/webm"
        self.prompt = "This is a test prompt"
        self.language = "en"
        self.response_format = "verbose_json"
        self.temperature = 0.5

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.read_audio_file")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_basic_params(
        self,
        mock_openai,
        mock_read_audio,
        mock_create_temp,
        mock_cleanup,
        mock_file_open,
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        mock_read_audio.return_value = self.audio_data
        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe
        transcriber = WhisperTranscriber(api_key=self.api_key, model=self.model)
        result = transcriber.transcribe(
            audio_input=self.filename, filename=self.filename
        )

        # Verify parameters passed correctly
        mock_read_audio.assert_called_once_with(self.filename)
        mock_create_temp.assert_called_once()
        mock_client.audio.transcriptions.create.assert_called_once()
        call_kwargs = mock_client.audio.transcriptions.create.call_args[1]
        self.assertEqual(call_kwargs["model"], self.model)
        self.assertIsNotNone(call_kwargs["file"])

        # Verify response structure
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)
        self.assertEqual(result["language"], TEST_LANGUAGE)
        mock_cleanup.assert_called_once_with(temp_file_path)

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_with_all_params(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse(
            duration=TEST_DURATION, words=[{"word": "test", "start": 0.0, "end": 0.5}]
        )
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe with all params
        transcriber = WhisperTranscriber(api_key=self.api_key, model=self.model)
        result = transcriber.transcribe(
            audio_input=self.audio_data,
            filename=self.filename,
            content_type=self.content_type,
            prompt=self.prompt,
            language=self.language,
            response_format=self.response_format,
            temperature=self.temperature,
        )

        # Verify all parameters passed correctly
        call_kwargs = mock_client.audio.transcriptions.create.call_args[1]
        self.assertEqual(call_kwargs["model"], self.model)
        self.assertEqual(call_kwargs["prompt"], self.prompt)
        self.assertEqual(call_kwargs["language"], self.language)
        self.assertEqual(call_kwargs["response_format"], self.response_format)
        self.assertEqual(call_kwargs["temperature"], self.temperature)

        # Verify response includes all metadata
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)
        self.assertEqual(result["language"], TEST_LANGUAGE)
        self.assertEqual(result["duration"], TEST_DURATION)
        self.assertIsNotNone(result["words"])

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_with_bytes_input(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe with bytes
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(
            audio_input=self.audio_data, filename=self.filename
        )

        # Verify bytes were used directly (read_audio_file not called)
        mock_client.audio.transcriptions.create.assert_called_once()
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.read_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_with_path_object(
        self,
        mock_openai,
        mock_validate,
        mock_read_audio,
        mock_create_temp,
        mock_cleanup,
        mock_file_open,
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        mock_read_audio.return_value = self.audio_data
        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        from pathlib import Path

        audio_path = Path(self.filename)

        # Create transcriber and call transcribe with Path object
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(audio_input=audio_path)

        # Verify response
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)
        self.assertEqual(result["language"], TEST_LANGUAGE)

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_with_optional_params_none(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe with None optional params
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(
            audio_input=self.audio_data, prompt=None, language=None, temperature=None
        )

        # Verify None params are passed correctly
        call_kwargs = mock_client.audio.transcriptions.create.call_args[1]
        self.assertIsNone(call_kwargs.get("prompt"))
        self.assertIsNone(call_kwargs.get("language"))
        self.assertIsNone(call_kwargs.get("temperature"))

        # Verify response
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_response_format_json(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe with json format
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(
            audio_input=self.audio_data, response_format="json"
        )

        # Verify response_format passed correctly
        call_kwargs = mock_client.audio.transcriptions.create.call_args[1]
        self.assertEqual(call_kwargs["response_format"], "json")

        # Verify response
        self.assertEqual(result["transcript"], TEST_TRANSCRIPT)


class WhisperTranscriberResponseTests(unittest.TestCase):
    def setUp(self):
        self.api_key = "test-api-key"
        self.audio_data = b"fake audio data" * 100

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_response_structure(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        mock_transcription = MockTranscriptionResponse(
            text="Test transcript",
            language="en",
            duration=10.5,
            words=[{"word": "test", "start": 0.0, "end": 0.5}],
        )
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(audio_input=self.audio_data)

        # Verify response structure
        self.assertIn("transcript", result)
        self.assertIn("language", result)
        self.assertIn("duration", result)
        self.assertIn("words", result)
        self.assertEqual(result["transcript"], "Test transcript")
        self.assertEqual(result["language"], "en")
        self.assertEqual(result["duration"], 10.5)
        self.assertEqual(len(result["words"]), 1)

    @patch("builtins.open", new_callable=mock_open)
    @patch("ragent.transcribe.openai.app.cleanup_temp_file")
    @patch("ragent.transcribe.openai.app.create_temp_audio_file")
    @patch("ragent.transcribe.openai.app.validate_audio_size")
    @patch("ragent.transcribe.openai.app.OpenAI")
    def test_transcribe_response_minimal(
        self, mock_openai, mock_validate, mock_create_temp, mock_cleanup, mock_file_open
    ):
        # Setup mocks
        mock_client = MagicMock()
        mock_openai.return_value = mock_client

        temp_file_path = "/tmp/test_audio.webm"
        mock_create_temp.return_value = temp_file_path

        # Mock response without duration and words - use spec to limit attributes
        class MinimalResponse:
            def __init__(self):
                self.text = "Minimal transcript"
                self.language = "fr"

        mock_transcription = MinimalResponse()
        mock_client.audio.transcriptions.create.return_value = mock_transcription

        # Create transcriber and call transcribe
        transcriber = WhisperTranscriber(api_key=self.api_key)
        result = transcriber.transcribe(audio_input=self.audio_data)

        # Verify minimal response structure
        self.assertIn("transcript", result)
        self.assertIn("language", result)
        self.assertNotIn("duration", result)
        self.assertNotIn("words", result)
        self.assertEqual(result["transcript"], "Minimal transcript")
        self.assertEqual(result["language"], "fr")


if __name__ == "__main__":
    unittest.main()
