import unittest
from unittest.mock import MagicMock, patch

from langchain_core.callbacks.base import BaseCallbackHandler

from ragent.llms.bedrock import (
    Bedrock,
    BedrockChat,
    get_bedrock_chat_model,
    get_bedrock_text_model,
)

TEST_RESPONSE = "test response"


class MockCallbackHandler(BaseCallbackHandler):
    def on_llm_start(self, serialized, prompts, **kwargs):
        # This method is intentionally left empty.
        # You can add actions to be performed when the LLM (Language Model) starts.
        # For example, logging, tracking prompt information, or triggering other tasks.
        pass

    def on_llm_end(self, response, **kwargs):
        # The method is intentionally left empty.
        # You can add post-processing actions to be performed once the LLM completes the response.

        pass

    def on_llm_error(self, error, **kwargs):
        # The method is intentionally left empty.
        # You can add error-handling mechanisms here.
        # For example, logging the error, notifying users, or retrying the operation.
        pass


class BedrockTextModelTests(unittest.TestCase):
    def setUp(self):
        self.model_id = "test-model-id"
        self.client = MagicMock()
        self.max_tokens = 512
        self.temperature = 0.5
        self.streaming = False
        self.callbacks = None

    def test_get_bedrock_text_model_basic(self):
        model = get_bedrock_text_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=self.callbacks,
        )
        self.assertIsInstance(model, Bedrock)
        self.assertEqual(model.model_id, self.model_id)
        self.assertEqual(model.client, self.client)
        self.assertEqual(model.streaming, self.streaming)
        self.assertEqual(
            model.model_kwargs,
            {"maxTokenCount": self.max_tokens, "temperature": self.temperature},
        )

    def test_get_bedrock_text_model_with_callbacks(self):
        mock_callbacks = [MockCallbackHandler()]
        model = get_bedrock_text_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=mock_callbacks,
        )
        self.assertEqual(model.callbacks, mock_callbacks)

    def test_get_bedrock_text_model_streaming(self):
        self.streaming = True
        model = get_bedrock_text_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=self.callbacks,
        )
        self.assertTrue(model.streaming)


class BedrockChatModelTests(unittest.TestCase):
    def setUp(self):
        self.model_id = "test-model-id"
        self.client = MagicMock()
        self.max_tokens = 512
        self.temperature = 0.5
        self.streaming = False
        self.callbacks = None

    def test_get_bedrock_chat_model_basic(self):
        model = get_bedrock_chat_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=self.callbacks,
        )
        self.assertIsInstance(model, BedrockChat)
        self.assertEqual(model.model_id, self.model_id)
        self.assertEqual(model.client, self.client)
        self.assertEqual(model.streaming, self.streaming)
        self.assertEqual(
            model.model_kwargs,
            {"max_tokens_to_sample": self.max_tokens, "temperature": self.temperature},
        )

    def test_get_bedrock_chat_model_with_callbacks(self):
        mock_callbacks = [MockCallbackHandler()]
        model = get_bedrock_chat_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=mock_callbacks,
        )
        self.assertEqual(model.callbacks, mock_callbacks)

    def test_get_bedrock_chat_model_streaming(self):
        self.streaming = True
        model = get_bedrock_chat_model(
            model_id=self.model_id,
            client=self.client,
            max_tokens=self.max_tokens,
            temperature=self.temperature,
            streaming=self.streaming,
            callbacks=self.callbacks,
        )
        self.assertTrue(model.streaming)


class BedrockModelConfigurationTests(unittest.TestCase):
    def test_text_model_kwargs(self):
        model = get_bedrock_text_model(
            model_id="test-model", client=MagicMock(), max_tokens=2048, temperature=0.7
        )
        self.assertEqual(
            model.model_kwargs, {"maxTokenCount": 2048, "temperature": 0.7}
        )

    def test_chat_model_kwargs(self):
        model = get_bedrock_chat_model(
            model_id="test-model", client=MagicMock(), max_tokens=2048, temperature=0.7
        )
        self.assertEqual(
            model.model_kwargs, {"max_tokens_to_sample": 2048, "temperature": 0.7}
        )


class BedrockModelIntegrationTests(unittest.TestCase):
    @patch("ragent.llms.bedrock.Bedrock")
    def test_text_model_generate(self, mock_bedrock):
        mock_instance = mock_bedrock.return_value
        mock_instance.invoke.return_value = TEST_RESPONSE

        model = get_bedrock_text_model(model_id="test-model", client=MagicMock())
        result = model.invoke(prompt="test prompt")
        self.assertEqual(result, TEST_RESPONSE)

    @patch("ragent.llms.bedrock.BedrockChat")
    def test_chat_model_generate(self, mock_bedrock_chat):
        mock_instance = mock_bedrock_chat.return_value
        mock_instance.invoke.return_value = TEST_RESPONSE

        model = get_bedrock_chat_model(model_id="test-model", client=MagicMock())
        result = model.invoke(messages=[{"role": "user", "content": "test prompt"}])
        self.assertEqual(result, TEST_RESPONSE)


if __name__ == "__main__":
    unittest.main()
