import sys
import unittest
from unittest.mock import MagicMock, patch

# Mock boto3 before any imports that might use it
sys.modules["boto3"] = MagicMock()

# Patch get_secret_value_from_secret_manager to return a test API key
with patch(
    "ragent.aws.secrets_manager.envs.get_secret_value_from_secret_manager",
    return_value="test-api-key",
):
    from ragent.transcribe import TranscriberFactory, TranscriberProviders


class TestTranscriberFactory(unittest.TestCase):
    def test_get_openai_transcriber_returns_instance(self):
        with patch("ragent.transcribe.factory.WhisperTranscriber") as mock_transcriber:
            mock_instance = MagicMock()
            mock_transcriber.return_value = mock_instance

            result = TranscriberFactory.get_transcriber(TranscriberProviders.OPENAI)

            mock_transcriber.assert_called_once_with()
            self.assertEqual(result, mock_instance)

    def test_get_openai_transcriber_passes_kwargs(self):
        with patch("ragent.transcribe.factory.WhisperTranscriber") as mock_transcriber:
            mock_instance = MagicMock()
            mock_transcriber.return_value = mock_instance

            kwargs = {
                "api_key": "test-key",
                "model": "test-model",
                "hallucination_check_enabled": False,
            }

            result = TranscriberFactory.get_transcriber(
                TranscriberProviders.OPENAI, **kwargs
            )

            mock_transcriber.assert_called_once_with(**kwargs)
            self.assertEqual(result, mock_instance)

    def test_get_transcriber_with_invalid_provider_raises(self):
        class FakeProvider:
            value = "fake"

            def __str__(self):
                return self.value

        with self.assertRaises(ValueError):
            TranscriberFactory.get_transcriber(FakeProvider())


if __name__ == "__main__":
    unittest.main()
