""""
Using the default retriever (RETRIEVER_TYPE_DEFAULT).
Using the multi-query retriever (RETRIEVER_TYPE_MULTI_QUERY) with logging.
Using the multi-vector retriever (RETRIEVER_TYPE_MULTI_VECTOR) with Redis.
Using the contextual Cohere retriever (RETRIEVER_TYPE_CONTEXTUAL_COHERE).
Using the contextual compressor retriever (RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR).
Using the ensemble retriever (RETRIEVER_TYPE_ENSEMBLE) with BM25.
Testing invalid configurations.
"""


import logging
import unittest
from io import StringIO
from unittest.mock import Mock, create_autospec, patch

from langchain_classic.retrievers import (
    ContextualCompressionRetriever,
    EnsembleRetriever,
)
from langchain_classic.retrievers.multi_query import MultiQueryRetriever
from langchain_classic.retrievers.multi_vector import MultiVectorRetriever
from langchain_core.documents import BaseDocumentCompressor
from langchain_core.runnables import Runnable
from langchain_core.stores import BaseStore
from langchain_core.vectorstores import VectorStore

from ragent.retriever.app import (
    RETRIEVER_TYPE_CONTEXTUAL_COHERE,
    RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR,
    RETRIEVER_TYPE_DEFAULT,
    RETRIEVER_TYPE_ENSEMBLE,
    RETRIEVER_TYPE_MULTI_QUERY,
    RETRIEVER_TYPE_MULTI_VECTOR,
    get_retriever,
)


class DirectRetrieverTests(unittest.TestCase):
    def setUp(self):
        self.vector_store = create_autospec(VectorStore)
        self.llm = Mock()
        self.bm25_retriever = create_autospec(Runnable)
        self.redis_url = "redis://localhost:6379"
        self.cohere_api_key = "oiAzPEnJpfjRRCd1FMJwFbpBXdYSGtcKu7kh934u"
        self.cohere_model = "rerank-english-v3.0"
        self.search_kwargs = {"k": 4}
        self.vector_store.as_retriever.return_value = create_autospec(Runnable)
        self.logger = logging.getLogger("ragent.retriever.app")
        self.logger.setLevel(logging.INFO)
        self.logger.handlers = []  # Clear handlers to avoid interfRedisStoreerence

    def test_default_retriever(self):
        """Test default retriever (Scenario 1)."""
        retriever = get_retriever(
            retriever_type=RETRIEVER_TYPE_DEFAULT,
            vector_store=self.vector_store,
            search_kwargs=self.search_kwargs,
        )
        self.vector_store.as_retriever.assert_called_with(
            search_type="similarity", search_kwargs=self.search_kwargs
        )
        self.assertIsInstance(retriever, Runnable)

    def test_multi_query_retriever(self):
        """Test MultiQueryRetriever via get_retriever (Scenario 2)."""
        with patch(
            "ragent.retriever.app.MultiQueryRetriever.from_llm",
            return_value=create_autospec(MultiQueryRetriever),
        ) as mock_from_llm:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_MULTI_QUERY,
                vector_store=self.vector_store,
                llm_for_retriever=self.llm,
                search_kwargs=self.search_kwargs,
            )
            mock_from_llm.assert_called_once_with(
                retriever=self.vector_store.as_retriever.return_value, llm=self.llm
            )
            self.assertIsInstance(retriever, MultiQueryRetriever)

    def test_multi_vector_retriever(self):
        """Test MultiVectorRetriever via get_retriever (Scenario 3)."""
        with patch(
            "ragent.retriever.app.RedisStore", return_value=create_autospec(BaseStore)
        ) as mock_redis:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_MULTI_VECTOR,
                vector_store=self.vector_store,
                redis_url=self.redis_url,
                search_kwargs=self.search_kwargs,
            )
            mock_redis.assert_called_once_with(redis_url=self.redis_url)
            self.assertIsInstance(retriever, MultiVectorRetriever)

    def test_contextual_cohere_retriever(self):
        """Test ContextualCompressionRetriever with Cohere via get_retriever (Scenario 4)."""
        with patch(
            "ragent.retriever.app.CohereRerank",
            return_value=create_autospec(BaseDocumentCompressor),
        ) as mock_cohere:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_CONTEXTUAL_COHERE,
                vector_store=self.vector_store,
                cohere_api_key=self.cohere_api_key,
                cohere_model=self.cohere_model,
                search_kwargs=self.search_kwargs,
            )
            mock_cohere.assert_called_once_with(
                cohere_api_key=self.cohere_api_key, model=self.cohere_model
            )
            self.assertIsInstance(retriever, ContextualCompressionRetriever)

    def test_contextual_compressor_retriever(self):
        with patch(
            "ragent.retriever.app.LLMChainExtractor.from_llm",
            return_value=create_autospec(BaseDocumentCompressor),
        ) as mock_extractor:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR,
                vector_store=self.vector_store,
                llm_for_retriever=self.llm,
                search_kwargs=self.search_kwargs,
            )
            mock_extractor.assert_called_once_with(self.llm)
            self.assertIsInstance(retriever, ContextualCompressionRetriever)

    def test_ensemble_retriever(self):
        """Test EnsembleRetriever via get_retriever (Scenario 6)."""
        with patch(
            "ragent.retriever.app.EnsembleRetriever",
            return_value=create_autospec(EnsembleRetriever),
        ) as mock_ensemble:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_ENSEMBLE,
                vector_store=self.vector_store,
                bm25_retriever=self.bm25_retriever,
                search_kwargs=self.search_kwargs,
            )
            mock_ensemble.assert_called_once_with(
                retrievers=[
                    self.bm25_retriever,
                    self.vector_store.as_retriever.return_value,
                ],
                weights=[0.5, 0.5],
            )
            self.assertIsInstance(retriever, EnsembleRetriever)


class RetrieverIntegrationTests(unittest.TestCase):
    def setUp(self):
        self.vector_store = create_autospec(VectorStore)
        self.llm = Mock()
        self.bm25_retriever = create_autospec(Runnable)
        self.log_capture = StringIO()
        self.redis_url = "redis://localhost:6379"
        self.cohere_api_key = "oiAzPEnJpfjRRCd1FMJwFbpBXdYSGtcKu7kh934u"
        self.cohere_model = "rerank-english-v3.0"
        self.vector_store.as_retriever.return_value = create_autospec(Runnable)
        self.logger = logging.getLogger("ragent.retriever.app")
        self.logger.setLevel(logging.INFO)
        self.logger.handlers = []  # Clear handlers to avoid interference

    def tearDown(self):
        self.log_capture.close()

    def test_default_retriever(self):
        retriever = get_retriever(
            retriever_type=RETRIEVER_TYPE_DEFAULT,
            vector_store=self.vector_store,
        )
        self.vector_store.as_retriever.assert_called_once()
        self.assertIsInstance(retriever, Runnable)

    def test_multi_vector_retriever(self):
        with patch(
            "ragent.retriever.app.RedisStore", return_value=create_autospec(BaseStore)
        ) as mock_redis:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_MULTI_VECTOR,
                vector_store=self.vector_store,
                redis_url=self.redis_url,
            )
            mock_redis.assert_called_once_with(redis_url=self.redis_url)
            self.assertIsInstance(retriever, MultiVectorRetriever)

    def test_contextual_cohere_retriever(self):
        with patch(
            "ragent.retriever.app.CohereRerank",
            return_value=create_autospec(BaseDocumentCompressor),
        ) as mock_cohere:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_CONTEXTUAL_COHERE,
                vector_store=self.vector_store,
                cohere_api_key=self.cohere_api_key,
                cohere_model=self.cohere_model,
            )
            mock_cohere.assert_called_once_with(
                cohere_api_key=self.cohere_api_key, model=self.cohere_model
            )
            self.assertIsInstance(retriever, ContextualCompressionRetriever)

    def test_contextual_compressor_retriever(self):
        with patch(
            "ragent.retriever.app.LLMChainExtractor.from_llm",
            return_value=create_autospec(BaseDocumentCompressor),
        ) as mock_extractor:
            retriever = get_retriever(
                retriever_type=RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR,
                vector_store=self.vector_store,
                llm_for_retriever=self.llm,
            )
            mock_extractor.assert_called_once_with(self.llm)
            self.assertIsInstance(retriever, ContextualCompressionRetriever)

    def test_ensemble_retriever(self):
        with patch(
            "ragent.retriever.app.EnsembleRetriever",
            return_value=create_autospec(EnsembleRetriever),
        ) as mock_ensemble:
            get_retriever(
                retriever_type=RETRIEVER_TYPE_ENSEMBLE,
                vector_store=self.vector_store,
                bm25_retriever=self.bm25_retriever,
            )
            mock_ensemble.assert_called_once_with(
                retrievers=[
                    self.bm25_retriever,
                    self.vector_store.as_retriever.return_value,
                ],
                weights=[0.5, 0.5],
            )

    def test_custom_search_kwargs(self):
        custom_kwargs = {"k": 10, "score_threshold": 0.5}
        get_retriever(
            retriever_type=RETRIEVER_TYPE_DEFAULT,
            vector_store=self.vector_store,
            search_kwargs=custom_kwargs,
        )
        self.vector_store.as_retriever.assert_called_with(
            search_type="similarity", search_kwargs=custom_kwargs
        )


class RetrieverErrorTests(unittest.TestCase):
    def setUp(self):
        self.vector_store = create_autospec(VectorStore)
        self.vector_store.as_retriever.return_value = create_autospec(Runnable)

    def test_multi_query_missing_llm(self):
        with self.assertRaises(ValueError) as cm:
            get_retriever(
                retriever_type=RETRIEVER_TYPE_MULTI_QUERY,
                vector_store=self.vector_store,
            )
        self.assertEqual(
            str(cm.exception), "LLM must be provided for MULTI_QUERY retriever type."
        )

    def test_contextual_cohere_missing_api_key(self):
        with self.assertRaises(ValueError) as cm:
            get_retriever(
                retriever_type=RETRIEVER_TYPE_CONTEXTUAL_COHERE,
                vector_store=self.vector_store,
                cohere_model="rerank-model",
            )
        self.assertEqual(
            str(cm.exception),
            "Cohere API key must be provided for CONTEXTUAL_COHERE retriever type.",
        )

    def test_ensemble_missing_bm25(self):
        with self.assertRaises(ValueError) as cm:
            get_retriever(
                retriever_type=RETRIEVER_TYPE_ENSEMBLE,
                vector_store=self.vector_store,
            )
        self.assertEqual(
            str(cm.exception),
            "BM25 retriever must be provided for ENSEMBLE retriever type.",
        )


if __name__ == "__main__":
    unittest.main()
