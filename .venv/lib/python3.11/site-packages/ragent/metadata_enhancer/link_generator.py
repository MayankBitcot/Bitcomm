"""
Link generation utilities for different datasource types.
"""
from typing import Optional
from urllib.parse import quote

PROTOCOL_SCHEMES = ("http://", "https://", "s3://")


class DataSourceLinkGenerator:
    """Generates page-specific links for different datasource types."""

    def __init__(self, base_url: Optional[str] = None):
        self.base_url = base_url

    def generate_pdf_page_link(
        self, file_path: str, page_number: int, base_url: Optional[str] = None
    ) -> str:
        """
        Generate a direct link to a specific page in a PDF.

        Args:
            file_path: Path or URL to the PDF file
            page_number: Page number (1-indexed)
            base_url: Base URL for the application (optional)

        Returns:
            Direct link to the specific page
        """
        # If it's an S3 URL or web URL, create a viewer link
        if file_path.startswith(PROTOCOL_SCHEMES):
            # For web-based PDF viewers, append #page=N
            return f"{file_path}#page={page_number}"

        # For local files or when base_url is provided
        if base_url:
            encoded_path = quote(file_path)
            return f"{base_url}/viewer/pdf?file={encoded_path}&page={page_number}"

        # Fallback: return file path with page reference
        return f"{file_path}#page={page_number}"

    def generate_csv_row_link(
        self, file_path: str, row_number: int, base_url: Optional[str] = None
    ) -> str:
        """
        Generate a link to a specific row in a CSV file.

        Args:
            file_path: Path or URL to the CSV file
            row_number: Row number (1-indexed)
            base_url: Base URL for the application (optional)

        Returns:
            Direct link to the specific row
        """
        # If it's an S3 URL or web URL, create a viewer link
        if file_path.startswith(PROTOCOL_SCHEMES):
            # For web-based CSV viewers, append #row=N
            return f"{file_path}#row={row_number}"

        if base_url:
            encoded_path = quote(file_path)
            return f"{base_url}/viewer/csv?file={encoded_path}&row={row_number}"

        return f"{file_path}#row={row_number}"

    def generate_document_section_link(
        self, file_path: str, section_id: str, base_url: Optional[str] = None
    ) -> str:
        """
        Generate a link to a specific section in a document.

        Args:
            file_path: Path or URL to the document
            section_id: Section identifier
            base_url: Base URL for the application (optional)

        Returns:
            Direct link to the specific section
        """
        # If it's an S3 URL or web URL, create a viewer link
        if file_path.startswith(PROTOCOL_SCHEMES):
            # For web-based document viewers, append #section=N
            return f"{file_path}#section={section_id}"

        if base_url:
            encoded_path = quote(file_path)
            return (
                f"{base_url}/viewer/document?file={encoded_path}&section={section_id}"
            )

        return f"{file_path}#section={section_id}"
