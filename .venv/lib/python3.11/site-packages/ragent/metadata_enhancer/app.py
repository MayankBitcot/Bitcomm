"""
Enhanced metadata handler for adding page-specific links and datasource information
to document embeddings.
"""
import datetime
import os
from typing import List, Optional

from langchain_core.documents import Document

from ragent.log_utils import logger
from ragent.metadata_enhancer.link_generator import DataSourceLinkGenerator


class MetadataEnhancer:
    """Enhances document metadata with datasource links and page information."""

    def __init__(self, base_url: Optional[str] = None, enable_page_links: bool = True):
        """
        Initialize the MetadataEnhancer.

        Args:
            base_url: Base URL for generating links
            enable_page_links: Whether to generate page-specific links
        """
        self.base_url = base_url
        self.enable_page_links = enable_page_links
        self.link_generator = DataSourceLinkGenerator(base_url)

    def _format_file_path_for_url(self, file_path: str) -> str:
        """
        Format file path for URL generation by replacing spaces with underscores.

        Args:
            file_path: Original file path

        Returns:
            Formatted file path with spaces replaced by underscores
        """
        return file_path.replace(" ", "_")

    def enhance_pdf_metadata(
        self, documents: List[Document], file_path: str, local_path: str, file_name: str
    ) -> List[Document]:
        """
        Enhance PDF document metadata with page-specific links.

        Args:
            documents: List of documents from PDF
            file_path: Original file path
            local_path: Local file path
            file_name: File name

        Returns:
            Documents with enhanced metadata
        """
        enhanced_docs = []

        for doc in documents:
            if "page" in doc.metadata:
                doc.metadata["page_number"] = doc.metadata["page"] + 1
            else:
                doc.metadata["page_number"] = 1  # fallback if no page info
            page_num = doc.metadata["page_number"]

            # Create enhanced metadata
            enhanced_metadata = doc.metadata.copy()
            enhanced_metadata.update(
                {
                    "title": file_name,
                    "datasource_path": file_path,
                    "file_extension": "pdf",
                    "content_type": "document",
                    "page_number": page_num,
                }
            )

            # Add page-specific link if enabled
            if self.enable_page_links:
                # Format file path for URL generation
                formatted_file_path = self._format_file_path_for_url(file_path)
                page_link = self.link_generator.generate_pdf_page_link(
                    formatted_file_path, page_num, self.base_url
                )
                enhanced_metadata["direct_link"] = page_link

            # Add file size and other metadata if available
            if os.path.exists(local_path):
                enhanced_metadata["file_size"] = os.path.getsize(local_path)
                modified_time = os.path.getmtime(local_path)
                formatted_last_modified = datetime.datetime.fromtimestamp(
                    modified_time
                ).strftime("%Y-%m-%d %H:%M:%S")
                enhanced_metadata["last_modified"] = formatted_last_modified

            # Create new document with enhanced metadata
            enhanced_doc = Document(
                page_content=doc.page_content, metadata=enhanced_metadata
            )
            enhanced_docs.append(enhanced_doc)

        logger.info(f"Enhanced {len(enhanced_docs)} PDF documents with page links")
        return enhanced_docs

    def enhance_csv_metadata(
        self, documents: List[Document], file_path: str, local_path: str, file_name: str
    ) -> List[Document]:
        """
        Enhance CSV document metadata with row-specific links.

        Args:
            documents: List of documents from CSV
            file_path: Original file path
            local_path: Local file path
            file_name: File name

        Returns:
            Documents with enhanced metadata
        """
        enhanced_docs = []

        for i, doc in enumerate(documents):
            row_num = doc.metadata.get("row", i + 1)

            enhanced_metadata = doc.metadata.copy()
            enhanced_metadata.update(
                {
                    "title": file_name,
                    "datasource_path": file_path,
                    "file_extension": "csv",
                    "content_type": "tabular",
                }
            )

            if self.enable_page_links:
                formatted_file_path = self._format_file_path_for_url(file_path)
                row_link = self.link_generator.generate_csv_row_link(
                    formatted_file_path, row_num, self.base_url
                )
                enhanced_metadata["direct_link"] = row_link

            # Add file size and other metadata if available
            if os.path.exists(local_path):
                enhanced_metadata["file_size"] = os.path.getsize(local_path)
                modified_time = os.path.getmtime(local_path)
                formatted_last_modified = datetime.datetime.fromtimestamp(
                    modified_time
                ).strftime("%Y-%m-%d %H:%M:%S")
                enhanced_metadata["last_modified"] = formatted_last_modified

            enhanced_doc = Document(
                page_content=doc.page_content, metadata=enhanced_metadata
            )
            enhanced_docs.append(enhanced_doc)

        logger.info(f"Enhanced {len(enhanced_docs)} CSV documents with row links")
        return enhanced_docs

    def enhance_text_metadata(
        self,
        documents: List[Document],
        file_path: str,
        file_ext: str,
        local_path: str,
        file_name: str,
    ) -> List[Document]:
        """
        Enhance text document metadata with section-specific links.

        Args:
            documents: List of documents from text files
            file_path: Original file path
            file_ext: File extension
            local_path: Local file path
            file_name: File name

        Returns:
            Documents with enhanced metadata
        """
        enhanced_docs = []

        for i, doc in enumerate(documents):
            section_id = f"section_{i+1}"

            enhanced_metadata = doc.metadata.copy()
            enhanced_metadata.update(
                {
                    "title": file_name,
                    "datasource_path": file_path,
                    "section_id": section_id,
                    "file_extension": file_ext,
                    "content_type": "text",
                }
            )

            if self.enable_page_links:
                formatted_file_path = self._format_file_path_for_url(file_path)
                section_link = self.link_generator.generate_document_section_link(
                    formatted_file_path, section_id, self.base_url
                )
                enhanced_metadata["direct_link"] = section_link

            # Add file size and other metadata if available
            if os.path.exists(local_path):
                enhanced_metadata["file_size"] = os.path.getsize(local_path)
                modified_time = os.path.getmtime(local_path)
                formatted_last_modified = datetime.datetime.fromtimestamp(
                    modified_time
                ).strftime("%Y-%m-%d %H:%M:%S")
                enhanced_metadata["last_modified"] = formatted_last_modified

            enhanced_doc = Document(
                page_content=doc.page_content, metadata=enhanced_metadata
            )
            enhanced_docs.append(enhanced_doc)

        logger.info(f"Enhanced {len(enhanced_docs)} text documents with section links")
        return enhanced_docs

    def enhance_documents(
        self, documents: List[Document], file_path: str, local_path: str
    ) -> List[Document]:
        """
        Enhance documents based on file type.

        Args:
            documents: List of documents to enhance
            file_path: Original file path
            local_path: Local file path

        Returns:
            Documents with enhanced metadata
        """
        if not documents:
            return documents

        # Determine file type
        file_ext = os.path.splitext(file_path)[1].lower()
        file_name = os.path.basename(file_path)
        logger.info(f"Enhancing documents '{file_name}' of type: {file_ext}")

        if file_ext == ".pdf":
            return self.enhance_pdf_metadata(
                documents, file_path, local_path, file_name
            )
        elif file_ext == ".csv":
            return self.enhance_csv_metadata(
                documents, file_path, local_path, file_name
            )
        else:
            # Default enhancement for unknown types or
            # if file_ext in [".txt", ".md", ".doc", ".docx"]
            return self.enhance_text_metadata(
                documents, file_path, file_ext, local_path, file_name
            )
