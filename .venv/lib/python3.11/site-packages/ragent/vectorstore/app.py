from typing import List

from langchain_community.vectorstores import PGVector
from langchain_core.documents import Document
from langchain_openai import OpenAIEmbeddings

from ragent.aws.secrets_manager.envs import get_secret_value_from_secret_manager, logger
from ragent.openai_constants import OpenAIConfig

driver = "psycopg2"
DATABASE_HOST = get_secret_value_from_secret_manager("DATABASE_HOST")
DATABASE_PORT = get_secret_value_from_secret_manager("DATABASE_PORT")
DATABASE_NAME = get_secret_value_from_secret_manager("DATABASE_NAME")
DATABASE_USER = get_secret_value_from_secret_manager("DATABASE_USER")
DATABASE_PASS = get_secret_value_from_secret_manager("DATABASE_PASS")
OPENAI_API_KEY = get_secret_value_from_secret_manager("OPENAI_API_KEY")

CONNECTION_STRING = (
    f"postgresql://{DATABASE_USER}:{DATABASE_PASS}"
    f"@{DATABASE_HOST}:{DATABASE_PORT}/{DATABASE_NAME}"
)


required_vars = [
    DATABASE_HOST,
    DATABASE_PORT,
    DATABASE_NAME,
    DATABASE_USER,
    DATABASE_PASS,
    OPENAI_API_KEY,
]

missing_vars = [str(var) for var in required_vars if not var]

if missing_vars:
    raise ValueError(
        f"Missing required environment variables: {', '.join(missing_vars)}"
    )


def get_pgvector_connection_string():
    """
    Get the default connection string using environment variables.

    Returns:
        str: The connection string for PGVector
    """
    return PGVector.connection_string_from_db_params(
        driver=driver,
        host=DATABASE_HOST,
        port=DATABASE_PORT,
        database=DATABASE_NAME,
        user=DATABASE_USER,
        password=DATABASE_PASS,
    )


def create_vector_store(embedding_function, collection_name, connection_string):
    """
    Core function to create a vector store instance.

    Args:
        embedding_function: The embedding function to use
        collection_name: Name of the collection
        connection_string: Database connection string

    Returns:
        PGVector: The vector store instance
    """

    # Create vector store with timing
    vector_store = PGVector(
        embedding_function=embedding_function,
        collection_name=collection_name,
        connection_string=connection_string,
        use_jsonb=True,
    )

    logger.info("Vector store created successfully")

    return vector_store


def insert_into_pgvector(
    documents: List[Document],
    collection_name: str,
    model: str = OpenAIConfig.EMBEDDING_MODEL_NAME,
):
    """
    Insert documents into PGVector using LangChain
    """
    try:
        OPENAI_API_KEY = get_secret_value_from_secret_manager("OPENAI_API_KEY")
        # Initialize OpenAI embeddings with API key
        embeddings = OpenAIEmbeddings(model=model, openai_api_key=OPENAI_API_KEY)

        logger.info(f"Using collection name: {collection_name}")
        logger.info("Generating embeddings and storing in PGVector...")

        # Store documents in PGVector
        PGVector.from_documents(
            embedding=embeddings,
            documents=documents,
            collection_name=collection_name,
            connection_string=CONNECTION_STRING,
        )

        logger.info(
            f"Successfully stored {len(list(documents))} documents with embeddings "
            f"in collection '{collection_name}'"
        )

        return True
    except Exception as e:
        logger.error(f"Error inserting data into PGVector: {e}")
        raise
