from typing import Any, Dict

from ragent.guardrails.custom_guardrails import create_config_builder, create_masker


class GuardrailManager:
    """Manager class to handle both custom and default guardrails based on user configuration"""

    def __init__(
        self,
        guardrail_type: str = "openai_guardrails",
        config_file: str = "config.json",
        model: str = "gpt-4o",
        temperature: float = 0.0,
    ):
        """
        Initialize GuardrailManager

        Args:
            guardrail_type: "openai_guardrails" or "custom_guardrails"
            config_file: Path to config file (for openai guardrails)
            model: OpenAI model to use (default: "gpt-4o")
            temperature: Temperature for the model (default: 0.0)
        """
        self.guardrail_type = guardrail_type.lower()
        self.config_file = config_file
        self.model = model
        self.temperature = temperature

        if self.guardrail_type == "openai_guardrails":
            try:
                from ragent.guardrails.default_openai_guardrails import (
                    GuardrailProcessor,
                )
            except ImportError:
                raise ImportError(
                    "GuardrailProcessor is not installed. Please install it using 'pip install ragent[guardrails]'"
                )

            self.processor = GuardrailProcessor(config_file, model, temperature)
        elif self.guardrail_type == "custom_guardrails":
            # Initialize with default custom config
            self.masker = create_masker(model=model, temperature=temperature)
        else:
            raise ValueError(
                "guardrail_type must be 'openai_guardrails' or 'custom_guardrails'"
            )

    async def process_text(
        self, user_query: str, instructions: str = None, **kwargs
    ) -> Dict[str, Any]:
        """
        Process text based on the configured guardrail type

        Args:
            user_query: Text to process
            instructions: Optional instructions (for default guardrails)
            **kwargs: Additional configuration for custom guardrails

        Returns:
            Dict containing the result from the appropriate guardrail tool
        """
        if self.guardrail_type == "openai_guardrails":
            return await self._process_with_openai_guardrails(user_query, instructions)
        elif self.guardrail_type == "custom_guardrails":
            return await self._process_with_custom_guardrails(user_query, **kwargs)
        else:
            raise ValueError(f"Unknown guardrail type: {self.guardrail_type}")

    async def _process_with_openai_guardrails(
        self, user_query: str, instructions: str = None
    ) -> Dict[str, Any]:
        """Process with OpenAI guardrails"""
        try:
            result = await self.processor.process_text(user_query, instructions)
            return {"type": "openai_guardrails", "result": result, "success": True}
        except Exception as e:
            return {
                "type": "openai_guardrails",
                "result": None,
                "success": False,
                "error": str(e),
            }

    async def _process_with_custom_guardrails(
        self, user_query: str, **kwargs
    ) -> Dict[str, Any]:
        """Process with custom guardrails"""
        try:
            # If custom config is provided, create new masker
            if kwargs:
                config = self._build_custom_config(**kwargs)
                masker = create_masker(
                    config, model=self.model, temperature=self.temperature
                )
            else:
                masker = self.masker

            result = masker.mask_sensitive_data(user_query)
            return {"type": "custom_guardrails", "result": result, "success": True}
        except Exception as e:
            return {
                "type": "custom_guardrails",
                "result": None,
                "success": False,
                "error": str(e),
            }

    def _build_custom_config(self, **kwargs):
        """Build custom configuration from kwargs"""
        builder = create_config_builder()

        # Enable/disable PII and PHI
        if "enable_pii" in kwargs:
            builder.enable_pii(kwargs["enable_pii"])
        if "enable_phi" in kwargs:
            builder.enable_phi(kwargs["enable_phi"])

        # Add custom entities
        if "custom_entities" in kwargs:
            builder.add_custom_entities(kwargs["custom_entities"])

        # Configure PII settings
        if "pii_config" in kwargs:
            builder.configure_pii(**kwargs["pii_config"])

        # Configure PHI settings
        if "phi_config" in kwargs:
            builder.configure_phi(**kwargs["phi_config"])

        return builder.build()

    def switch_guardrail_type(
        self,
        new_type: str,
        config_file: str = "config.json",
        model: str = None,
        temperature: float = None,
    ):
        """Switch between OpenAI and custom guardrails"""
        self.guardrail_type = new_type.lower()
        self.config_file = config_file

        # Update model and temperature if provided
        if model is not None:
            self.model = model
        if temperature is not None:
            self.temperature = temperature

        if self.guardrail_type == "openai_guardrails":
            try:
                from ragent.guardrails.default_openai_guardrails import (
                    GuardrailProcessor,
                )
            except ImportError:
                raise ImportError(
                    "GuardrailProcessor is not installed. Please install it using 'pip install ragent[guardrails]'"
                )

            self.processor = GuardrailProcessor(
                config_file, self.model, self.temperature
            )
        elif self.guardrail_type == "custom_guardrails":
            self.masker = create_masker(model=self.model, temperature=self.temperature)
        else:
            raise ValueError(
                "guardrail_type must be 'openai_guardrails' or 'custom_guardrails'"
            )
