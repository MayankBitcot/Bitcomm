from enum import Enum
from typing import List, Optional

from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field

from ragent.log_utils import logger

# ============================================================================
# DATA MODELS
# ============================================================================


class EntitySpan(BaseModel):
    """Represents a span of text that contains sensitive information."""

    entity: str = Field(
        ...,
        description="The type or name of the detected entity (e.g., 'email', 'phone').",
    )
    start_word: int = Field(
        ..., description="The index of the first word of the entity (1-based)."
    )
    end_word: int = Field(
        ..., description="The index of the last word of the entity (inclusive)."
    )


class MaskingResult(BaseModel):
    """Structured output for masked queries"""

    query: str = Field(description="The input text with all PII/PHI entities masked.")
    entities: List[str] = Field(
        default_factory=list,
        description="A list of entities that were detected and masked.",
    )
    spans: List[EntitySpan] = Field(
        default_factory=list,
        description="Detailed info for each entity: its start and end word positions in the query.",
    )
    strategy_used: str = Field(
        default="UNIFIED", description="The strategy used to mask the sensitive data."
    )
    original_text: str = Field(description="The original text that was masked.")


class EntityType(Enum):
    """Enum for different entity types (Strategy Pattern)"""

    PII = "pii"
    PHI = "phi"
    CUSTOM = "custom"


# ============================================================================
# CONFIGURATION MODELS (Builder Pattern)
# ============================================================================


class PIIConfig(BaseModel):
    """Pydantic model for PII (Personally Identifiable Information) masking configuration"""

    name: bool = Field(default=True, description="name")
    emails: bool = Field(default=True, description="email addresses")
    age: bool = Field(default=True, description="age")
    phones: bool = Field(default=True, description="phone numbers")
    credit_cards: bool = Field(default=True, description="credit card numbers")
    addresses: bool = Field(default=True, description="addresses")
    account_numbers: bool = Field(default=True, description="account numbers")
    credit_debit_card_details: bool = Field(
        default=True, description="credit/debit card details"
    )
    username: bool = Field(default=True, description="username")
    password: bool = Field(default=True, description="password details")


class PHIConfig(BaseModel):
    """Pydantic model for PHI (Protected Health Information) masking configuration"""

    medical_records: bool = Field(default=True, description="medical record numbers")
    dates_of_birth: bool = Field(default=True, description="dates of birth")
    medical_conditions: bool = Field(
        default=True,
        description="medical conditions (diseases, illnesses, symptoms, diagnoses)",
    )
    patient_ids: bool = Field(default=True, description="Any form of IDs")
    insurance_numbers: bool = Field(default=True, description="insurance numbers")
    medical_history: bool = Field(default=True, description="medical history")


class SensitiveInfoConfig(BaseModel):
    """Pydantic model for combined PII and PHI masking configuration"""

    enable_pii: bool = Field(default=True, description="Enable PII masking")
    enable_phi: bool = Field(default=True, description="Enable PHI masking")
    custom_entities: List[str] = Field(
        default_factory=list, description="Custom entity types to detect and mask"
    )
    pii_config: PIIConfig = Field(default_factory=PIIConfig)
    phi_config: PHIConfig = Field(default_factory=PHIConfig)


class MaskingConfigBuilder:
    """Builder for creating complex masking configurations (Builder Pattern)"""

    def __init__(self):
        self.config = SensitiveInfoConfig()

    def enable_pii(self, enabled: bool = True) -> "MaskingConfigBuilder":
        """Enable or disable PII masking."""
        self.config.enable_pii = enabled
        return self

    def enable_phi(self, enabled: bool = True) -> "MaskingConfigBuilder":
        """Enable or disable PHI masking."""
        self.config.enable_phi = enabled
        return self

    def add_custom_entities(self, entities: List[str]) -> "MaskingConfigBuilder":
        """Add custom entities to detect."""
        self.config.custom_entities.extend(entities)
        return self

    def configure_pii(self, **kwargs) -> "MaskingConfigBuilder":
        """Configure PII settings."""
        for key, value in kwargs.items():
            if hasattr(self.config.pii_config, key):
                setattr(self.config.pii_config, key, value)
        return self

    def configure_phi(self, **kwargs) -> "MaskingConfigBuilder":
        """Configure PHI settings."""
        for key, value in kwargs.items():
            if hasattr(self.config.phi_config, key):
                setattr(self.config.phi_config, key, value)
        return self

    def build(self) -> SensitiveInfoConfig:
        """Build the final configuration."""
        return self.config


class SensitiveInfoMasker:
    """Simple service that handles PII and PHI masking with single LLM call"""

    def __init__(
        self,
        config: SensitiveInfoConfig,
        model: str = "gpt-4o",
        temperature: float = 0.0,
    ):
        self.config = config
        self.llm = ChatOpenAI(
            model=model,
            temperature=temperature,
        )

    def _apply_masking(
        self, text: str, system_message: Optional[str] = None
    ) -> MaskingResult:
        """Apply masking using a single unified approach - ONE LLM call for everything."""
        try:
            # Build unified instruction for ALL entity types
            all_entity_types = []

            # Add PII entities if enabled
            if self.config.enable_pii:
                for (
                    field_name,
                    is_enabled,
                ) in self.config.pii_config.model_dump().items():
                    if is_enabled:
                        field_info = PIIConfig.model_fields[field_name]
                        all_entity_types.append(field_info.description)

            # Add PHI entities if enabled
            if self.config.enable_phi:
                for (
                    field_name,
                    is_enabled,
                ) in self.config.phi_config.model_dump().items():
                    if is_enabled:
                        field_info = PHIConfig.model_fields[field_name]
                        all_entity_types.append(field_info.description)

            # Add custom entities if provided
            if self.config.custom_entities:
                all_entity_types.extend(self.config.custom_entities)

            # If no entities to detect, return original text
            if not all_entity_types:
                return MaskingResult(
                    query=text, original_text=text, strategy_used="UNIFIED"
                )

            # Single unified prompt for ALL entity types
            unified_prompt = f"""Your task is to identify and mask any sensitive information in the user's input. The sensitive information types are: {', '.join(all_entity_types)}.
- Replace each character of any detected sensitive information with an asterisk (*).
- Include all masked entities types in the entities list, along with their positions in the text.
- Provide the positions by word indices, specifying the start and end word index for each entity.
- For each entity, include its type and its word position range.
- If no sensitive information is found, return the original text unchanged with an empty entities list."""

            # Single LLM call for everything
            messages = []
            if system_message:
                messages.append(
                    {
                        "role": "system",
                        "content": f"{system_message}\n\n{unified_prompt}",
                    }
                )
            else:
                messages.append({"role": "system", "content": unified_prompt})

            messages.append({"role": "user", "content": text})

            # Single LLM call
            structured_llm = self.llm.with_structured_output(MaskingResult)
            result = structured_llm.invoke(messages)
            result.strategy_used = "UNIFIED"
            result.original_text = text

            return result

        except Exception as e:
            logger.error(f"Error in masking: {str(e)}")
            return MaskingResult(
                query=text, original_text=text, strategy_used="UNIFIED"
            )

    def mask_sensitive_data(
        self, user_query: str, system_message: Optional[str] = None
    ) -> MaskingResult:
        """Simple method for masking sensitive data - single LLM call for everything."""
        return self._apply_masking(user_query, system_message)


# ============================================================================
# SIMPLE FACTORY FUNCTIONS
# ============================================================================


def create_masker(
    config: Optional[SensitiveInfoConfig] = None,
    model: str = "gpt-4o",
    temperature: float = 0.0,
) -> SensitiveInfoMasker:
    """Simple factory function to create a masker instance"""
    return SensitiveInfoMasker(config or SensitiveInfoConfig(), model, temperature)


def create_config_builder() -> MaskingConfigBuilder:
    """Factory function to create a configuration builder (Factory Pattern)"""
    return MaskingConfigBuilder()
