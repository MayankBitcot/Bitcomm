"""
Command pattern implementation for Voice Package
"""

from abc import ABC, abstractmethod
from typing import Any, Dict


class IAsyncCommand(ABC):
    """Interface for async commands that can be queued"""

    @abstractmethod
    async def execute(self) -> Any:
        """Execute the command and return result"""
        pass

    @abstractmethod
    def can_execute(self) -> bool:
        """Check if command can be executed"""
        pass

    @abstractmethod
    def get_client_id(self) -> str:
        """Get the client ID for this command"""
        pass


class ProcessTranscriptAndCreateTTSCommand(IAsyncCommand):
    """Composite command that processes transcript and creates TTS"""

    def __init__(
        self,
        client_id: str,
        transcript: str,
        conversation_orchestrator,
        tts_service,
    ):
        self._client_id = client_id
        self._transcript = transcript
        self._conversation_orchestrator = conversation_orchestrator
        self._tts_service = tts_service

    async def execute(self) -> Dict[str, Any]:
        """Execute the composite command"""
        try:
            # Process transcript - callback will call TTS directly
            result = await self._conversation_orchestrator.process_transcript(
                self._client_id, self._transcript
            )

            return {
                "success": True,
                "client_id": self._client_id,
                "transcript": self._transcript,
                "result": result,
            }

        except Exception as e:
            return {
                "success": False,
                "client_id": self._client_id,
                "error": str(e),
                "transcript": self._transcript,
            }

    def can_execute(self) -> bool:
        """Check if command can be executed"""
        return bool(self._client_id and self._transcript.strip())

    def get_client_id(self) -> str:
        """Get the client ID for this command"""
        return self._client_id


class CommandFactory:
    """Factory for creating commands"""

    def __init__(self, conversation_orchestrator, tts_service):
        self._conversation_orchestrator = conversation_orchestrator
        self._tts_service = tts_service

    def create_composite_command(
        self, client_id: str, transcript: str
    ) -> ProcessTranscriptAndCreateTTSCommand:
        """Create a composite command"""
        return ProcessTranscriptAndCreateTTSCommand(
            client_id,
            transcript,
            self._conversation_orchestrator,
            self._tts_service,
        )
