"""
Universal Socket.IO Handler

This module provides a universal Socket.IO handler that automatically detects
whether the underlying Socket.IO implementation is sync (Flask-SocketIO) or
async (python-socketio) and handles emit() calls accordingly.

This eliminates the need for separate adapters and makes the voice gateway
work with ANY Socket.IO implementation automatically.
"""
import inspect
from typing import Any, Callable, Optional

from ragent.voice_gateway.utils.async_helpers import safe_emit


class UniversalSocketIOHandler:
    """
    Universal Socket.IO handler that works with both sync and async implementations.

    Automatically detects:
    - Flask-SocketIO (sync)
    - python-socketio AsyncServer (async)
    - Any other Socket.IO implementation

    Features:
    - Auto-detection of sync vs async
    - Task garbage collection prevention for async
    - Works with any framework (Flask, FastAPI, Django, Sanic, Tornado, Aiohttp)
    - No adapter needed!

    Usage:
        # Works with Flask-SocketIO
        from flask_socketio import SocketIO
        socketio = SocketIO(app)
        handler = UniversalSocketIOHandler(socketio)

        # Works with python-socketio
        import socketio
        sio = socketio.AsyncServer()
        handler = UniversalSocketIOHandler(sio)

        # Use the same interface for both!
        handler.emit('event', {'data': 'value'})
    """

    def __init__(self, socketio_instance):
        """
        Initialize the universal handler.

        Args:
            socketio_instance: Either Flask-SocketIO or python-socketio AsyncServer
        """
        self._socketio = socketio_instance
        self._is_async = self._detect_async_mode()
        self._current_sid = None

    def _detect_async_mode(self) -> bool:
        """
        Detect if the Socket.IO instance is async or sync.

        Returns:
            True if async (python-socketio), False if sync (Flask-SocketIO)
        """
        # Check if it's python-socketio AsyncServer
        if hasattr(self._socketio, "async_mode"):
            return True

        # Check if emit method is a coroutine
        if hasattr(self._socketio, "emit"):
            emit_method = getattr(self._socketio, "emit")
            if inspect.iscoroutinefunction(emit_method):
                return True

        # Check class name
        class_name = self._socketio.__class__.__name__
        if "Async" in class_name or "async" in class_name.lower():
            return True

        # Default to sync (Flask-SocketIO)
        return False

    def emit(self, event: str, data: Any = None, **kwargs) -> None:
        """
        Emit an event to clients.

        Automatically handles both sync and async Socket.IO implementations.
        Uses safe_emit helper which prevents task garbage collection for async.

        Args:
            event: The event name
            data: The data to send
            **kwargs: Additional options (e.g., 'to', 'room', 'namespace')
        """
        # Convert 'to' parameter to 'room' for python-socketio compatibility
        if "to" in kwargs and self._is_async:
            kwargs["room"] = kwargs.pop("to")

        # Use safe_emit helper - works with both sync and async!
        safe_emit(self._socketio.emit, event, data, **kwargs)

    def on(self, event: str, handler: Callable) -> None:
        """
        Register an event handler.

        Automatically wraps the handler for async Socket.IO to extract sid.

        Args:
            event: The event name
            handler: The handler function (accepts *args, **kwargs)
        """
        if self._is_async:
            self._on_async(event, handler)
        else:
            self._on_sync(event, handler)

    def _on_sync(self, event: str, handler: Callable) -> None:
        """
        Register event handler for sync Socket.IO (Flask-SocketIO).

        Args:
            event: The event name
            handler: The handler function
        """
        self._socketio.on(event)(handler)

    def _on_async(self, event: str, handler: Callable) -> None:
        """
        Register event handler for async Socket.IO (python-socketio).

        Wraps the handler to extract and store sid.

        Args:
            event: The event name
            handler: The handler function
        """

        async def wrapped_handler(sid, *args, **kwargs):
            self._current_sid = sid
            try:
                # Call the original handler with all arguments
                result = handler(*args, **kwargs)
                # Handle both sync and async handlers
                if inspect.iscoroutine(result):
                    return await result
                return result
            finally:
                self._current_sid = None

        self._socketio.on(event)(wrapped_handler)

    def on_error(self, handler: Callable) -> None:
        """
        Register an error handler.

        Args:
            handler: The error handler function
        """
        if hasattr(self._socketio, "on_error_default"):
            # Flask-SocketIO
            self._socketio.on_error_default(handler)
        # python-socketio doesn't have a direct on_error handler

    def get_current_client_id(self) -> Optional[str]:
        """
        Get the current client ID from the request context.

        Returns:
            The client/session ID or None
        """
        if self._is_async:
            # For async Socket.IO, we store it in wrapped handler
            return self._current_sid
        else:
            # For Flask-SocketIO, get from request context
            try:
                from flask import request

                return request.sid
            except (ImportError, RuntimeError):
                return None

    async def cleanup(self):
        """
        Cleanup pending tasks (for async Socket.IO only).

        Tasks are now managed by safe_emit helper in the event loop.
        This method is kept for backward compatibility but does nothing.
        """
        pass

    @property
    def is_async(self) -> bool:
        """Check if the Socket.IO instance is async."""
        return self._is_async

    @property
    def socketio(self):
        """Get the underlying Socket.IO instance."""
        return self._socketio


def create_universal_handler(socketio_instance) -> UniversalSocketIOHandler:
    """
    Factory function to create a universal Socket.IO handler.

    Args:
        socketio_instance: Either Flask-SocketIO or python-socketio AsyncServer

    Returns:
        UniversalSocketIOHandler instance

    Example:
        # Flask
        from flask_socketio import SocketIO
        socketio = SocketIO(app)
        handler = create_universal_handler(socketio)

        # FastAPI
        import socketio
        sio = socketio.AsyncServer()
        handler = create_universal_handler(sio)

        # Both work the same way!
        handler.emit('event', {'data': 'value'})
    """
    return UniversalSocketIOHandler(socketio_instance)
