"""
Voice Gateway - Framework-agnostic voice gateway implementation.

This module provides the core functionality for voice processing and WebSocket communication,
allowing integration with any web framework through the WebFrameworkAdapter interface.
"""
import logging
from typing import Any, Callable, Dict, List, Optional

from ragent.voice_gateway.config.config import ConfigService
from ragent.voice_gateway.core.app_managers import ApplicationOrchestrator
from ragent.voice_gateway.core.voice_handler import VoiceHandler
from ragent.voice_gateway.interfaces.web_framework import (
    WebApp,
    WebFrameworkAdapter,
    WebSocketHandler,
)
from ragent.voice_gateway.utils.exceptions import ConfigurationError

logger = logging.getLogger(__name__)


class VoiceGateway:
    """
    Voice Gateway application wrapper.

    This class provides the main interface for the voice gateway, handling the integration
    between the web framework, WebSocket communication, and voice processing.
    """

    def __init__(
        self,
        framework_adapter: WebFrameworkAdapter,
        voice_handler: VoiceHandler,
        orchestrator: ApplicationOrchestrator,
        event_emitter: Any,
    ):
        """
        Initialize the VoiceGateway.

        Args:
            framework_adapter: An instance of WebFrameworkAdapter for framework integration
            voice_handler: The voice handler for processing audio and text
            orchestrator: The application orchestrator
            event_emitter: The event emitter for WebSocket communication
        """
        self._framework_adapter = framework_adapter
        self._voice_handler = voice_handler
        self._orchestrator = orchestrator
        self._event_emitter = event_emitter
        self._app = framework_adapter.get_app_instance()
        self._websocket = framework_adapter.get_websocket_handler()

    @property
    def app(self) -> WebApp:
        """Get the web application instance"""
        return self._app

    @property
    def websocket(self) -> WebSocketHandler:
        """Get the WebSocket handler instance"""
        return self._websocket

    @property
    def event_emitter(self):
        """Get the event emitter instance"""
        return self._event_emitter

    def run(self, host: str = "0.0.0.0", port: int = 5000, **kwargs):
        """
        Start the voice gateway.

        Args:
            host: The host to bind to (default: "0.0.0.0")
            port: The port to listen on (default: 5000)
            **kwargs: Additional arguments passed to the framework's run method
        """
        if hasattr(self._framework_adapter, "run"):
            self._framework_adapter.run(host=host, port=port, **kwargs)
        else:
            self._orchestrator.run(host, port, **kwargs)

    def shutdown(self):
        """Shutdown the gateway gracefully"""
        self._orchestrator.shutdown()


class CreateVoiceGateway:
    """
    Factory class for creating VoiceGateway instances.

    This class provides a convenient way to instantiate and configure a voice gateway
    by encapsulating all the initialization logic.

    Example:
        # Direct class method call (recommended)
        gateway = CreateVoiceGateway.create(
            framework_adapter=adapter,
            on_transcript=my_callback,
            config_overrides={"model": "gpt-4o-realtime-preview"}
        )

        # Or with function calling mode
        gateway = CreateVoiceGateway.create(
            framework_adapter=adapter,
            tools=my_tools,
            function_map=my_functions
        )

        # Run the gateway
        gateway.run(host="0.0.0.0", port=5000)
    """

    def __init__(
        self,
        framework_adapter: WebFrameworkAdapter,
        on_transcript: Optional[Callable] = None,
        tools: Optional[List[Dict[str, Any]]] = None,
        function_map: Optional[Dict[str, Callable]] = None,
        config_overrides: Optional[Dict[str, Any]] = None,
        callback_timeout: int = 120,
    ):
        """
        Initialize the CreateVoiceGateway factory.

        Args:
            framework_adapter: An instance of WebFrameworkAdapter for framework integration
            on_transcript: Optional callback function for agent wrapper mode:
                async def on_transcript(session_id: str, transcript: str,
                                       chat_payload: dict, event_emitter: Any,
                                       TTS: Callable) -> dict
                - Callback receives TTS function and calls it with text to speak
                - Returns dict with optional context updates: {"contextId": str, "message_log": list}
            tools: Optional list of tool definitions for function calling mode:
                [{"type": "function", "name": "function_name", "description": "...", "parameters": {...}}]
            function_map: Optional dict mapping function names to callables (required if tools provided):
                {"function_name": actual_function}
            config_overrides: Optional dict to override config values
            callback_timeout: Timeout in seconds for callback execution (default: 120)

        Note:
            - If tools provided: Uses function calling mode (ignores on_transcript)
            - If on_transcript provided: Uses agent wrapper mode (ignores tools)
            - Cannot use both modes simultaneously
        """
        self.framework_adapter = framework_adapter
        self.on_transcript = on_transcript
        self.tools = tools
        self.function_map = function_map
        self.config_overrides = config_overrides
        self.callback_timeout = callback_timeout

    @classmethod
    def create(
        cls,
        framework_adapter: WebFrameworkAdapter,
        on_transcript: Optional[Callable] = None,
        tools: Optional[List[Dict[str, Any]]] = None,
        function_map: Optional[Dict[str, Callable]] = None,
        config_overrides: Optional[Dict[str, Any]] = None,
        callback_timeout: int = 120,
    ) -> VoiceGateway:
        """
        Create and return a VoiceGateway instance.

        Args:
            framework_adapter: An instance of WebFrameworkAdapter for framework integration
            on_transcript: Optional callback function for agent wrapper mode
            tools: Optional list of tool definitions for function calling mode
            function_map: Optional dict mapping function names to callables
            config_overrides: Optional dict to override config values
            callback_timeout: Timeout in seconds for callback execution (default: 120)

        Returns:
            VoiceGateway instance with .app, .websocket, and .event_emitter properties

        Raises:
            ValueError: If configuration parameters are invalid
            ConfigurationError: If gateway creation fails
        """
        try:
            # Validate input parameters
            if tools and on_transcript:
                raise ValueError(
                    "Cannot use both 'tools' and 'on_transcript'. Choose one mode: "
                    "function calling (tools) or agent wrapper (on_transcript)."
                )

            if not tools and not on_transcript:
                raise ValueError(
                    "Must provide either 'tools' (function calling mode) or "
                    "'on_transcript' (agent wrapper mode)."
                )

            if tools and not function_map:
                raise ValueError(
                    "If 'tools' is provided, 'function_map' is required to map "
                    "function names to callables."
                )

            # Prepare config overrides with tools if provided
            final_config_overrides = config_overrides.copy() if config_overrides else {}
            if tools:
                final_config_overrides["tools"] = tools
                tool_choice = final_config_overrides.get("tool_choice", "auto")
                final_config_overrides["tool_choice"] = tool_choice
                logger.info("Function calling mode enabled with %d tool(s)", len(tools))
            else:
                logger.info("Agent wrapper mode enabled")

            # Initialize configuration service
            config_service = ConfigService(config_overrides=final_config_overrides)

            # Validate configuration
            validation_result = config_service.validate_configuration()
            if not validation_result["valid"]:
                raise ConfigurationError(
                    "Invalid configuration",
                    config_section="validation",
                )

            # Get app and websocket from the provided adapter
            app = framework_adapter.get_app_instance()
            websocket = framework_adapter.get_websocket_handler()

            # Initialize voice handler
            voice_handler = VoiceHandler(
                config_service=config_service,
                on_transcript_callback=on_transcript,
                callback_timeout=callback_timeout,
                function_map=function_map,
            )
            voice_handler.set_event_emitter(websocket)

            # Initialize application orchestrator
            orchestrator = ApplicationOrchestrator(
                app,
                websocket,
                voice_handler,
                config_service,
            )

            # Initialize all components
            orchestrator.initialize()

            # Get event emitter
            event_emitter = voice_handler._event_emitter

            return VoiceGateway(
                framework_adapter, voice_handler, orchestrator, event_emitter
            )

        except Exception as e:
            raise ConfigurationError(
                f"Failed to create voice gateway: {str(e)}", config_section="gateway"
            )
