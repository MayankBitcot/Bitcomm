from abc import ABC, abstractmethod
from typing import Any, Callable, Dict, Optional


class IAudioService(ABC):
    """Interface for audio processing operations"""

    @abstractmethod
    def validate_audio_format(self, audio_data: str) -> Dict[str, Any]:
        """Validate audio format and return validation result"""
        pass

    @abstractmethod
    def calculate_audio_duration(self, audio_data: str) -> float:
        """Calculate audio duration in milliseconds"""
        pass

    @abstractmethod
    def accumulate_audio(self, client_id: str, audio_data: str) -> None:
        """Accumulate audio data for a client"""
        pass

    @abstractmethod
    def get_total_duration(self, client_id: str) -> float:
        """Get total accumulated audio duration for a client"""
        pass

    @abstractmethod
    def clear_audio_buffer(self, client_id: str) -> None:
        """Clear audio buffer for a client"""
        pass


class ISessionService(ABC):
    """Interface for session management"""

    @abstractmethod
    def create_session(
        self, client_id: str, chat_payload: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Create a new session for a client"""
        pass

    @abstractmethod
    def get_session(self, client_id: str) -> Optional[Dict[str, Any]]:
        """Get session data for a client"""
        pass

    @abstractmethod
    def update_session(self, client_id: str, data: Dict[str, Any]) -> None:
        """Update session data for a client"""
        pass

    @abstractmethod
    def end_session(self, client_id: str) -> Dict[str, Any]:
        """End session for a client"""
        pass

    @abstractmethod
    def is_session_active(self, client_id: str) -> bool:
        """Check if session is active for a client"""
        pass


class IWebSocketService(ABC):
    """Interface for WebSocket communication with OpenAI"""

    @abstractmethod
    def connect(
        self,
        client_id: str,
        on_message: Callable,
        on_error: Callable,
        on_close: Callable,
    ) -> bool:
        """Connect to OpenAI WebSocket for a client"""
        pass

    @abstractmethod
    def send_message(self, client_id: str, message: Dict[str, Any]) -> bool:
        """Send message to OpenAI WebSocket"""
        pass

    @abstractmethod
    def disconnect(self, client_id: str) -> None:
        """Disconnect WebSocket for a client"""
        pass

    @abstractmethod
    def is_connected(self, client_id: str) -> bool:
        """Check if WebSocket is connected for a client"""
        pass


class IEventEmitter(ABC):
    """Interface for event emission to clients"""

    @abstractmethod
    def emit_to_client(self, client_id: str, event: str, data: Dict[str, Any]) -> None:
        """Emit event to specific client"""
        pass

    @abstractmethod
    def emit(self, event: str, data: Dict[str, Any], client_id: str = None) -> None:
        """Emit event (generic method for callback usage)"""
        pass


class IConfigService(ABC):
    """Interface for configuration management"""

    @abstractmethod
    def get_openai_config(self) -> Dict[str, Any]:
        """Get OpenAI configuration"""
        pass

    @abstractmethod
    def get_server_config(self) -> Dict[str, Any]:
        """Get server configuration"""
        pass

    @abstractmethod
    def get_audio_constraints(self) -> Dict[str, Any]:
        """Get audio processing constraints"""
        pass

    @abstractmethod
    def get_session_config_json(self) -> str:
        """Get session configuration as JSON string"""
        pass
