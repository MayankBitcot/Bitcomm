"""
Web framework interfaces and adapters for the voice gateway.
"""
from abc import ABC, abstractmethod
from typing import Any, Callable, Generic, TypeVar

T = TypeVar("T")


class WebApp(ABC):
    """Abstract base class for web application frameworks."""

    @abstractmethod
    def add_route(
        self, rule: str, endpoint: str, view_func: Callable, **options
    ) -> None:
        """Add a URL rule."""
        pass

    @abstractmethod
    def run(self, host: str = "0.0.0.0", port: int = 5000, **options) -> None:
        """Run the web application."""
        pass

    @abstractmethod
    def get_wsgi_app(self):
        """Get the underlying WSGI application."""
        pass


class WebSocketHandler(ABC):
    """
    Abstract base class for WebSocket handlers.

    This interface is designed to be framework-agnostic and work with any Socket.IO
    implementation including Flask-SocketIO, python-socketio, Django Channels,
    Tornado, Sanic, Aiohttp, and others.

    Event handlers registered via `on()` will receive flexible arguments (*args, **kwargs)
    to accommodate different framework signatures:
    - Flask-SocketIO: connect() - no arguments
    - python-socketio (async): connect(sid, environ) - requires sid
    - Django/Tornado/Sanic/Aiohttp: may have different signatures
    """

    @abstractmethod
    def on(self, event: str, handler: Callable) -> None:
        """
        Register an event handler.

        Args:
            event: The event name (e.g., 'connect', 'disconnect', 'audio_data')
            handler: A callable that accepts flexible arguments (*args, **kwargs)
        """
        pass

    @abstractmethod
    def on_error(self, handler: Callable) -> None:
        """
        Register an error handler.

        Args:
            handler: A callable that accepts an error and flexible arguments (e, *args, **kwargs)
        """
        pass

    @abstractmethod
    def emit(self, event: str, data: Any = None, **kwargs) -> None:
        """
        Emit an event to the client.

        Args:
            event: The event name
            data: The data to send
            **kwargs: Additional framework-specific options (e.g., 'to', 'room', 'namespace')
        """
        pass

    @abstractmethod
    def get_current_client_id(self) -> str:
        """
        Get the current client ID from the request context.

        Returns:
            The unique client/session identifier (e.g., request.sid in Flask-SocketIO)
        """
        pass


class WebFrameworkAdapter(ABC, Generic[T]):
    """Base class for web framework adapters."""

    @abstractmethod
    def create_app(self, **config) -> T:
        """Create a new web application instance."""
        pass

    @abstractmethod
    def create_websocket_handler(self, app: T, **kwargs) -> WebSocketHandler:
        """Create a WebSocket handler for the web application."""
        pass

    @abstractmethod
    def get_app_instance(self) -> WebApp:
        """Get the web application instance."""
        pass

    @abstractmethod
    def get_websocket_handler(self) -> WebSocketHandler:
        """Get the WebSocket handler instance."""
        pass
