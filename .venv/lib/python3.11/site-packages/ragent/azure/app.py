from typing import Optional

import httpx
from langchain_openai.chat_models import AzureChatOpenAI
from langchain_openai.embeddings import AzureOpenAIEmbeddings
from openai import AsyncAzureOpenAI, AzureOpenAI

from ragent.log_utils import logger


def create_azure_chat_openai(
    deployment_name: Optional[str] = None,
    api_key: Optional[str] = None,
    api_version: Optional[str] = None,
    azure_endpoint: Optional[str] = None,
) -> AzureChatOpenAI:
    """Create an instance of AzureChatOpenAI for LLM interactions"""

    chat = AzureChatOpenAI(
        deployment_name=deployment_name,
        openai_api_key=api_key,
        openai_api_version=api_version,
        azure_endpoint=azure_endpoint,
    )
    logger.info("Azure OpenAI chat initialization")
    return chat


def create_azure_openai_embeddings(
    model_name: Optional[str] = None,
    deployment_name: Optional[str] = None,
    api_key: Optional[str] = None,
    api_version: Optional[str] = None,
    azure_endpoint: Optional[str] = None,
) -> AzureOpenAIEmbeddings:
    """Create an instance of AzureOpenAIEmbeddings for embeddings"""

    embedding = AzureOpenAIEmbeddings(
        deployment=deployment_name,
        openai_api_key=api_key,
        azure_endpoint=azure_endpoint,
        openai_api_version=api_version,
        model=model_name,
    )
    logger.info("Azure OpenAI embeddings client initialization")
    return embedding


def create_azure_openai_client(
    deployment_name: Optional[str] = None,
    api_key: Optional[str] = None,
    api_version: Optional[str] = None,
    azure_endpoint: Optional[str] = None,
) -> AsyncAzureOpenAI:
    """Create an instance of AsyncAzureOpenAI client for direct API access"""

    client = AsyncAzureOpenAI(
        api_key=api_key,
        api_version=api_version,
        azure_endpoint=azure_endpoint,
        azure_deployment=deployment_name,
        default_headers={"api-key": api_key},
        http_client=httpx.AsyncClient(verify=False),
    )
    logger.info("Azure OpenAI client initialization")
    return client


def create_standard_azure_openai(
    api_key: Optional[str] = None,
    api_version: Optional[str] = "2024-08-01-preview",
    azure_endpoint: Optional[str] = None,
) -> AzureOpenAI:
    """Create an instance of the standard AzureOpenAI client"""

    client = AzureOpenAI(
        api_key=api_key,
        api_version=api_version,
        azure_endpoint=azure_endpoint,
    )
    logger.info("Azure OpenAI client initialization")
    return client
