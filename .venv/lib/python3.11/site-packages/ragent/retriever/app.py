import logging
from typing import Any, Dict, Optional

from langchain_classic.retrievers import (
    ContextualCompressionRetriever,
    EnsembleRetriever,
)
from langchain_classic.retrievers.document_compressors import LLMChainExtractor
from langchain_classic.retrievers.multi_query import MultiQueryRetriever
from langchain_classic.retrievers.multi_vector import MultiVectorRetriever
from langchain_cohere import CohereRerank
from langchain_community.storage import RedisStore

from ragent.constants import COHERE_API_KEY, COHERE_MODEL, REDIS_URI

# Set up logging
logger = logging.getLogger(__name__)

# Retriever types as constants instead of using app-specific enum
RETRIEVER_TYPE_DEFAULT = "DEFAULT"
RETRIEVER_TYPE_MULTI_QUERY = "MULTI_QUERY"
RETRIEVER_TYPE_MULTI_VECTOR = "MULTI_VECTOR"
RETRIEVER_TYPE_CONTEXTUAL_COHERE = "CONTEXTUAL_COHERE"
RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR = "CONTEXTUAL_COMPRESSOR"
RETRIEVER_TYPE_ENSEMBLE = "ENSEMBLE"


# String handler for capturing logs
class StringHandler(logging.Handler):
    def __init__(self, string_io):
        super().__init__()
        self.string_io = string_io

    def emit(self, record):
        self.string_io.write(self.format(record) + "\n")


def configure_logging(log_capture_string):
    """Configure logging for retrievers"""
    log_handler = StringHandler(log_capture_string)
    log_handler.setFormatter(
        logging.Formatter("%(asctime)s - %(levelname)s - %(message)s")
    )
    logger.setLevel(logging.INFO)
    logger.addHandler(log_handler)
    return logger


def validate_search_kwargs(
    search_kwargs: Optional[Dict[str, Any]], num_retrieved_documents: int
) -> Dict[str, Any]:
    """Ensure that search kwargs are valid, and set a default 'k' parameter."""
    if search_kwargs is None:
        search_kwargs = {"k": num_retrieved_documents}
    elif "k" not in search_kwargs:
        search_kwargs["k"] = num_retrieved_documents
    return search_kwargs


def create_multi_query_retriever(
    vector_store, search_type, search_kwargs, llm_for_retriever
):
    """Initialize and return a MultiQueryRetriever."""
    if not llm_for_retriever:
        raise ValueError("LLM must be provided for MULTI_QUERY retriever type.")
    return MultiQueryRetriever.from_llm(
        retriever=vector_store.as_retriever(
            search_type=search_type, search_kwargs=search_kwargs
        ),
        llm=llm_for_retriever,
    )


def create_multi_vector_retriever(vector_store, search_type, search_kwargs, redis_url):
    """Initialize and return a MultiVectorRetriever."""
    if not redis_url:
        raise ValueError("Redis URL must be provided for MULTI_VECTOR retriever type.")
    store = RedisStore(redis_url=redis_url)
    return MultiVectorRetriever(
        vectorstore=vector_store,
        docstore=store,
        id_key="doc_id",
        search_type=search_type,
        search_kwargs=search_kwargs,
    )


def create_contextual_cohere_retriever(
    vector_store, search_type, search_kwargs, cohere_api_key, cohere_model
):
    """Initialize and return a ContextualCompressionRetriever."""
    if not cohere_api_key:
        raise ValueError(
            "Cohere API key must be provided for CONTEXTUAL_COHERE retriever type."
        )
    if not cohere_model:
        raise ValueError(
            "Cohere model must be provided for CONTEXTUAL_COHERE retriever type."
        )
    compressor = CohereRerank(cohere_api_key=cohere_api_key, model=cohere_model)
    base_retriever = vector_store.as_retriever(
        search_type=search_type, search_kwargs=search_kwargs
    )
    return ContextualCompressionRetriever(
        base_compressor=compressor, base_retriever=base_retriever
    )


def create_contextual_compressor_retriever(
    vector_store, search_type, search_kwargs, llm_for_retriever
):
    """Initialize and return a ContextualCompressionRetriever."""
    if not llm_for_retriever:
        raise ValueError(
            "LLM must be provided for CONTEXTUAL_COMPRESSOR retriever type."
        )
    compressor = LLMChainExtractor.from_llm(llm_for_retriever)
    base_retriever = vector_store.as_retriever(
        search_type=search_type, search_kwargs=search_kwargs
    )
    return ContextualCompressionRetriever(
        base_compressor=compressor, base_retriever=base_retriever
    )


def create_ensemble_retriever(vector_store, search_type, search_kwargs, bm25_retriever):
    """Initialize and return an EnsembleRetriever."""
    if not bm25_retriever:
        raise ValueError("BM25 retriever must be provided for ENSEMBLE retriever type.")
    vector_store_retriever = vector_store.as_retriever(
        search_type=search_type, search_kwargs=search_kwargs
    )
    return EnsembleRetriever(
        retrievers=[bm25_retriever, vector_store_retriever], weights=[0.5, 0.5]
    )


def get_retriever(
    retriever_type: str,
    vector_store: Any,
    llm_for_retriever: Optional[Any] = None,
    num_retrieved_documents: int = 4,
    bm25_retriever: Optional[Any] = None,
    log_capture_string: Optional[Any] = None,
    search_type: str = "similarity",
    search_kwargs: Optional[Dict[str, Any]] = None,
    redis_url: Optional[str] = REDIS_URI,
    cohere_api_key: Optional[str] = COHERE_API_KEY,
    cohere_model: Optional[str] = COHERE_MODEL,
):
    """
    Factory function that returns the appropriate retriever based on the retriever type.

    Args:
        retriever_type: The type of retriever to use
        vector_store: The vector store to use for retrievals
        llm_for_retriever: The LLM to use for special retriever types
        num_retrieved_documents: Number of documents to retrieve
        bm25_retriever: Optional BM25 retriever for ensemble retrieval
        log_capture_string: StringIO object to capture logs (for multi-query)
        search_type: Type of search to perform
        search_kwargs: Additional search parameters
        redis_url: Redis URL for multi-vector retrievers.
        cohere_api_key: API key for Cohere. Defaults to COHERE_API_KEY
        cohere_model: Model name for Cohere. Defaults to COHERE_MODEL

    Returns:
        A configured retriever instance
    """
    # Ensure search kwargs are valid
    search_kwargs = validate_search_kwargs(search_kwargs, num_retrieved_documents)

    # Handle different retriever types
    if retriever_type == RETRIEVER_TYPE_MULTI_QUERY:
        logger.info("Using MULTI_QUERY retriever.")
        if log_capture_string:
            configure_logging(log_capture_string)
        return create_multi_query_retriever(
            vector_store, search_type, search_kwargs, llm_for_retriever
        )

    elif retriever_type == RETRIEVER_TYPE_MULTI_VECTOR:
        logger.info("Using MULTI_VECTOR retriever.")
        return create_multi_vector_retriever(
            vector_store, search_type, search_kwargs, redis_url
        )

    elif retriever_type == RETRIEVER_TYPE_CONTEXTUAL_COHERE:
        logger.info("Using CONTEXTUAL_COHERE retriever.")
        return create_contextual_cohere_retriever(
            vector_store, search_type, search_kwargs, cohere_api_key, cohere_model
        )

    elif retriever_type == RETRIEVER_TYPE_CONTEXTUAL_COMPRESSOR:
        logger.info("Initializing Contextual compression retriever.")
        return create_contextual_compressor_retriever(
            vector_store, search_type, search_kwargs, llm_for_retriever
        )

    elif retriever_type == RETRIEVER_TYPE_ENSEMBLE:
        logger.info("Initializing Ensemble retriever.")
        return create_ensemble_retriever(
            vector_store, search_type, search_kwargs, bm25_retriever
        )

    else:
        logger.info("Using DEFAULT retriever.")
        return vector_store.as_retriever(
            search_type=search_type, search_kwargs=search_kwargs
        )
