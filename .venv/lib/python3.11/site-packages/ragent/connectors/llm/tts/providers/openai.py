import base64
import os

from ragent.connectors.llm.tts.base import TextToSpeech, TextToSpeechError
from ragent.log_utils import logger
from ragent.openai_constants import OpenAIConfig


class OpenAITextToSpeech(TextToSpeech):
    def __init__(self):
        try:
            import openai

            os.environ["OPENAI_API_KEY"] = OpenAIConfig.API_KEY
            self.client = openai.OpenAI()
        except ImportError:
            raise ImportError(
                "openai is not installed. Please install it for OpenAI STT."
            )

    def process_text(
        self,
        input: str,
        model: str = OpenAIConfig.TTS_MODEL_NAME,
        voice: str = OpenAIConfig.VOICE,
    ) -> str:
        try:
            response = self.client.audio.speech.create(
                model=model, voice=voice, input=input
            )
            audio_content = response.read()
            encoded_audio = base64.b64encode(audio_content).decode("utf-8")
            return encoded_audio
        except Exception as e:
            logger.error(f"OpenAI API error during transcription: {e}", exc_info=True)
            raise TextToSpeechError(f"OpenAI API error during transcription: {e}")
