import os

import openai

from ragent.core.stt import BaseSpeechToText, SpeechToTextError
from ragent.log_utils import logger
from ragent.openai_constants import OpenAIConfig


class OpenAISpeechToText(BaseSpeechToText):
    def __init__(self):
        """Initialize OpenAISpeechToText with OpenAI API client."""
        try:
            # Ensure the OpenAI API key is set in the environment variables
            os.environ["OPENAI_API_KEY"] = OpenAIConfig.API_KEY
            self.client = openai.OpenAI()
        except ImportError:
            raise ImportError(
                "openai is not installed. Please install it for OpenAI STT."
            )

    def _speech_to_text(
        self,
        path: str,
        stt_prompt: str = None,
        model_name: str = OpenAIConfig.STT_MODEL_NAME,
    ) -> str:
        """Transcribe audio file to text using OpenAI's API."""
        try:
            # Open the audio file for transcription
            with open(path, "rb") as audio_file:
                # Using OpenAI's API for speech-to-text
                response = self.client.audio.transcriptions.create(
                    model=model_name,  # Use the model_name parameter
                    file=audio_file,
                    response_format="text",
                    prompt=stt_prompt,
                )

            # Extract and return the transcribed text

        except (
            openai.APIStatusError,
            openai.APIConnectionError,
            openai.RateLimitError,
        ) as e:
            logger.error(f"OpenAI API error during transcription: {e}", exc_info=True)
            raise SpeechToTextError(
                f"OpenAI API error during transcription: {e}"
            ) from e

        except Exception as e:
            logger.error(
                f"An unexpected error occurred during OpenAI transcription: {e}",
                exc_info=True,
            )

            raise SpeechToTextError(
                f"An unexpected error occurred during transcription: {e}"
            ) from e

        text = str(response).strip()

        logger.info(f"Transcribed text (first 50 chars): {text[:50]}...")
        return text
