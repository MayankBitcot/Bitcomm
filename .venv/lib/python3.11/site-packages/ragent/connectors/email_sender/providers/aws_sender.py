from ragent.connectors.email_sender.base import EmailSender
from ragent.log_utils import logger


class AwsEmailSender(EmailSender):
    def __init__(self):
        try:
            from ragent.aws.secrets_manager.envs import (
                get_secret_value_from_secret_manager,
            )
            from ragent.aws.session import get_or_refresh_session

            session = get_or_refresh_session()
            self.client = session.client(
                "ses", region_name=get_secret_value_from_secret_manager("REGION_NAME")
            )
        except ImportError:
            raise ImportError(
                "boto3 is not installed. Please install it for AWS email sending."
            )

    def _send(
        self, from_email: str, to_email: str, email_body: str, subject: str
    ) -> bool:
        try:
            self.client.send_email(
                Source=from_email,
                Destination={"ToAddresses": [to_email]},
                Message={
                    "Subject": {"Data": subject},
                    "Body": {"Html": {"Data": email_body}},
                },
            )
            return True
        except Exception as e:
            logger.error(f"Failed to send email: {str(e)}")
            return False
