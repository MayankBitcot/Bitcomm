import json
import os
from typing import Optional

from ragent.aws.session import get_or_refresh_session
from ragent.log_utils import logger


# Function to get secret value from environment
def get_secret_value_from_environment(key: str) -> str:
    return os.getenv(key)


# Function to get secret value securely from AWS Secrets Manager
def get_secret_value_from_secret_manager(key: str) -> Optional[str]:
    CI: str = get_secret_value_from_environment("CI")
    if CI:  # Assuming CI is defined elsewhere
        try:
            SEC_SERVICE = get_secret_value_from_environment("SEC_SERVICE")
            SEC_NAME = get_secret_value_from_environment("SEC_NAME")
            SEC_KEY = get_secret_value_from_environment("SEC_KEY")
            # Create a Secrets Manager client
            session = get_or_refresh_session()
            client = session.client(service_name=SEC_SERVICE)
            # Retrieve the secret
            get_secret_value_response = client.get_secret_value(SecretId=SEC_NAME)
            # Access the desired value using its key
            data = json.loads(get_secret_value_response.get("SecretString"))
            if SEC_KEY:
                nested_secret_str = data.get(SEC_KEY)
                if not nested_secret_str:
                    logger.error(f"No secret found for SEC_KEY: {SEC_KEY}")
                    return None
                try:
                    nested_secrets = json.loads(nested_secret_str)
                except json.JSONDecodeError as e:
                    logger.error(f"Eror parsing JSON from nested_secret_str: {str(e)}")
                    return None
            else:
                nested_secrets = data
            secret_value = nested_secrets.get(key)
            return secret_value
        except Exception as e:
            logger.error(f"Error retrieving secret from AWS Secrets Manager: {str(e)}")
            # Handle exception appropriately, possibly raise or return None
            return None
    else:
        return get_secret_value_from_environment(key)
