import os

import psycopg2
from sqlalchemy import Engine, create_engine
from sqlalchemy.orm import Session, sessionmaker

from ragent.aws.secrets_manager.envs import get_secret_value_from_secret_manager
from ragent.constants import DATABASE_URI

conn = psycopg2.connect(
    host=os.environ.get(
        "PGVECTOR_HOST", get_secret_value_from_secret_manager("DATABASE_HOST")
    ),
    user=os.environ.get(
        "PGVECTOR_USER", get_secret_value_from_secret_manager("DATABASE_USER")
    ),
    password=os.environ.get(
        "PGVECTOR_PASSWORD", get_secret_value_from_secret_manager("DATABASE_PASS")
    ),
    database=os.environ.get(
        "PGVECTOR_DATABASE", get_secret_value_from_secret_manager("DATABASE_NAME")
    ),
)


def get_engine(uri: str) -> Engine:
    """Makes an engine that connects to the SQL database given by the uri"""
    return create_engine(url=uri)


def get_db_conn_engine() -> Engine:
    """Creates the engine to connect to the database"""
    return get_engine(DATABASE_URI)


def get_session(connection_uri: str = "") -> Session:
    """
    Get a standard session for postgres

    Args:
        connection_uri (str, optional): url for the db

    Returns:
        sqlalchemy.orm.Session
    """
    engine = get_engine(connection_uri)
    session_maker = sessionmaker(bind=engine)
    session = session_maker()
    return session
