import logging
from typing import Any, Dict, Tuple

from ragent.aws.session import get_or_refresh_session

# Configure logging
logger = logging.getLogger(__name__)
# Define MIME types
CONTENT_TYPES: Dict[str, str] = {
    "pdf": "application/pdf",
    "csv": "text/csv",
    "doc": "application/msword",
    "docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "md": "text/markdown",
    "txt": "text/plain",
    "png": "image/png",
    "jpg": "image/jpeg",
    "jpeg": "image/jpeg",
}


def generate_s3_signed_url(
    user_id: int,
    extension: str,
    filename: str,
    json: bool,
    bucket: str,
    s3_folder_prefix: str,
    s3_json_folder_prefix: str,
    cloudfront_url: str,
) -> Tuple[str, str, str]:
    """
    Generates presigned URLs for file uploads to S3.
    Args:
        user_id (int): The ID of the user.
        extension (str): The file extension.
        filename (str): The base name of the file.
        json (bool): Flag to determine if file should be stored in JSON folder.
        bucket (str): S3 bucket name.
        s3_folder_prefix (str): S3 folder prefix for non-JSON files.
        s3_json_folder_prefix (str): S3 folder prefix for JSON files.
        cloudfront_url (str): CloudFront URL prefix.
    Returns:
        tuple: (presigned URL, file storage path with CloudFront URL, content type).
    """
    logger.debug(
        f"Generating signed URL for user_id={user_id}, filename={filename}, json={json}"
    )
    logger.info("Generating presigned URL...")
    session = get_or_refresh_session()
    s3 = session.client("s3")

    def obtain_signed_url(params: Dict[str, Any]) -> str:
        response = s3.generate_presigned_url(
            ClientMethod="put_object",
            Params=params,
            ExpiresIn=3600,
        )
        return response if response else ""

    content_type = CONTENT_TYPES.get(extension)
    if json:
        file_storage_path = f"{s3_json_folder_prefix}/{user_id}/{filename}"
    else:
        file_storage_path = f"{s3_folder_prefix}/{user_id}/{filename}"
    params = {
        "Bucket": bucket,
        "Key": file_storage_path,
        "ContentType": content_type,
    }
    return (
        obtain_signed_url(params),
        f"{cloudfront_url}{file_storage_path}",
        content_type,
    )
