import base64
from datetime import datetime, timezone
from typing import Dict, List, Union

import boto3

from ragent.aws.session import get_or_refresh_session
from ragent.constants import BUCKET, CLOUDFRONT_URL
from ragent.log_utils import logger


def init_s3_client() -> boto3.client:
    """
    Initialize an S3 client.

    Returns:
        An S3 client object.
    """
    session = get_or_refresh_session()
    return session.client("s3")


def upload_images_to_s3(
    user_req: Dict[str, Union[List, Dict[str, str]]],
    bucket: str = BUCKET,
    cloudfront_url: str = CLOUDFRONT_URL,
) -> Union[List[Dict[str, str]], List]:
    """
    Uploads base64 images from user_req to S3 and returns a dictionary with image paths.

    Args:
        user_req (Dict[str, Union[List, Dict[str, str]]]): A dictionary containing 'base_64' and 'n_images' keys.
            'base_64' is a dictionary where keys are image names and values are base64-encoded image data.
            'n_images' is the number of images expected.
        bucket (str, optional): S3 bucket name. Defaults to BUCKET.
        cloudfront_url (str, optional): Optional CloudFront URL prefix. Defaults to CLOUDFRONT_URL.

    Returns:
        Union[List[Dict[str, str]], List]: A list of dictionaries with 'key' and 'url' for each uploaded image.
            Returns an empty list if upload fails.
    """
    try:
        # Initialize S3 client
        s3_client = init_s3_client()

        # Convert input format to expected structure
        base64_images = {item.key: item.value for item in user_req["base_64"]}
        n_image = user_req["n_images"]

        logger.info(f"Received {n_image} base64 images")

        if len(base64_images) < n_image:
            logger.error(
                f"Expected {n_image} base64 images, but received {len(base64_images)}"
            )
            return []

        s3_urls = []

        for image_name, base64_image in base64_images.items():
            try:
                # Extract base64 data after the comma
                image_data = base64_image.split(",")[1]

                # Decode the base64 string to binary data
                image_binary = base64.b64decode(image_data)

                # Upload to S3
                timestamp = datetime.now(timezone.utc).strftime("%Y%m%d%H%M%S")
                s3_key = f"images/{image_name}_{timestamp}.jpeg"
                s3_client.put_object(
                    Bucket=bucket,
                    Key=s3_key,
                    Body=image_binary,
                    ContentType="image/jpeg",
                )

                # Generate the CloudFront or S3 URL
                image_url = (
                    f"{cloudfront_url}{s3_key}"
                    if cloudfront_url
                    else f"https://{bucket}.s3.amazonaws.com/{s3_key}"
                )

                s3_urls.append({"key": image_name, "url": image_url})

            except Exception as e:
                logger.error(f"Error uploading image {image_name}: {e}")
                continue

        return s3_urls

    except Exception as e:
        logger.error(f"Error processing base64 images: {e}")
        return []
