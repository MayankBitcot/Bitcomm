import os
from typing import Optional

from botocore.exceptions import ClientError
from dotenv import load_dotenv

from ragent.aws.session import get_or_refresh_session
from ragent.constants import BUCKET


class S3Manager:
    def __init__(self):
        load_dotenv()
        self.ci = os.getenv("CI")
        self.bucket_name = BUCKET

    def delete_files_from_local(self, file: str) -> None:
        """
        Deletes a file from the local system.

        Args:
            file (str): The path to the file to be deleted.

        Returns:
            None

        Raises:
            OSError: If an error occurs during file deletion.
        """
        if os.path.isfile(file):
            try:
                os.remove(file)
                print("Deleted file from local")
            except OSError as e:
                print(f"Error: {self.file} : {e.strerror}")

    def download_csv(
        self, file_path: Optional[str] = None, file_name: Optional[str] = None
    ) -> bool:
        """
        Downloads a CSV file from an Amazon S3 bucket.

        Args:
            file_path (Optional[str], optional): The path to the file in the S3 bucket.
                Defaults to self.file.
            file_name (Optional[str], optional): The name of the file to download.
                Defaults to self.filename.

        Returns:
            bool: True if the download is successful, False otherwise.

        Raises:
            ClientError: If there is an error downloading the file from S3.
        """
        try:
            file_name = file_name or self.filename
            file_path = file_path or self.file
            print(
                f"Attempting to download file - file_path {file_path}, file_name {file_name}"
            )

            session = get_or_refresh_session()

            s3 = session.resource("s3")
            s3.Bucket(self.bucket_name).download_file(file_path, file_name)
            return True

        except ClientError as e:
            print(f"Failed to download file from '{self.bucket_name}/{file_path}': {e}")
            return False
