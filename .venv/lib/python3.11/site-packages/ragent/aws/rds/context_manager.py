from contextlib import contextmanager

from sqlalchemy.exc import SQLAlchemyError

from ragent.aws.rds.db import db
from ragent.log_utils import logger


@contextmanager
def database_operation(operation, obj=None, **kwargs):
    """Perform database operations using context manager."""
    session = db.session
    try:
        if operation == "scope":
            yield session
        elif operation == "insert":
            new_obj = obj(**kwargs)
            session.add(new_obj)
            yield new_obj
        else:
            raise ValueError("Invalid operation specified")
        session.commit()
    except SQLAlchemyError as e:
        session.rollback()
        logger.error(
            f"An error occurred during database operation: {str(e)}", exc_info=True
        )
        raise
    finally:
        session.close()
