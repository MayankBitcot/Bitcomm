from flask import Flask

from ragent.constants import DATABASE_URI
from ragent.log_utils import logger


def get_app(db) -> Flask:
    app = Flask(__name__)

    try:
        app.config["SQLALCHEMY_DATABASE_URI"] = DATABASE_URI

        app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
        db.init_app(app)

    except Exception as e:
        logger.error(f"Failed to initialize database: {str(e)}")
        # Set a default SQLite database for development/testing
        app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///:memory:"
        app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
        db.init_app(app)

    return app
