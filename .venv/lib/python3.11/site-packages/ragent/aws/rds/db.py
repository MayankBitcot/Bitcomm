from flask_sqlalchemy import SQLAlchemy
from sqlalchemy.exc import SQLAlchemyError

from ragent.log_utils import logger

# Create a single SQLAlchemy instance
db = SQLAlchemy()


def add_and_commit(session, instance):
    """
    Add an instance to the session and commit.
    Rollback the transaction if an error occurs.

    Parameters:
    session (Session): SQLAlchemy session object.
    instance: Instance to add and commit.

    Returns:
    bool: True if the transaction was successful, False otherwise.
    """
    try:
        session.add(instance)
        session.commit()
        return True
    except SQLAlchemyError as e:
        session.rollback()
        logger.error(f"An error occurred: {e}")
        return False


def update_and_commit(session, instance):
    """
    Commit the session with an updated instance.
    Rollback the transaction if an error occurs.

    Parameters:
    session (Session): SQLAlchemy session object.
    instance: Instance to update and commit.

    Returns:
    bool: True if the transaction was successful, False otherwise.
    """
    try:
        session.add(instance)  # Add the instance to the session
        session.commit()  # Commit the session
        return True
    except SQLAlchemyError as e:
        session.rollback()  # Rollback on error
        logger.error(f"An error occurred: {e}")
        return False


def delete_and_commit(session, instance):
    """
    Commit the session with delete instance.
    Rollback the transaction if an error occurs.

    Parameters:
    session (Session): SQLAlchemy session object.
    instance: Instance to delete and commit.

    Returns:
    bool: True if the transaction was successful, False otherwise.
    """
    try:
        session.delete(instance)  # Delete the instance to the session
        session.commit()  # Commit the session
        return True
    except SQLAlchemyError as e:
        session.rollback()  # Rollback on error
        logger.error(f"An error occurred: {e}")
        return False


def db_query(*entities, **kwargs):
    """
    Perform a query on the database.

    Parameters:
    entities: Entities to query.
    kwargs: Additional filter arguments.

    Returns:
    Query: SQLAlchemy query object.
    """
    try:
        return db.session.query(*entities).filter_by(**kwargs)
    except SQLAlchemyError as e:
        logger.error(f"An error occurred: {e}")
        raise
