"""                                                                                                                                                                             
AWS Session Management Module                                                                                                                                                   
                                                                                                                                                                                
Provides boto3 session creation with appropriate credential source:                                                                                                             
- Lambda: Uses IAM role via boto3 default credential chain                                                                                                                      
- Hetzner/K8s: Reads fresh credentials from ~/.aws/credentials file                                                                                                             
- Local dev: Uses boto3 default (env vars or credentials file)                                                                                                                  
"""                                                                                                                                                                             
                                                                                                                                                                                
import configparser                                                                                                                                                             
import logging                                                                                                                                                                  
import os                                                                                                                                                                       
from pathlib import Path                                                                                                                                                        
from typing import Dict, Optional                                                                                                                                               
                                                                                                                                                                                
import boto3                                                                                                                                                                    
                                                                                                                                                                                
# Configure logger                                                                                                                                                              
logger = logging.getLogger(__name__)                                                                                                                                            
                                                                                                                                                                                
# Constants for AWS credentials file handling                                                                                                                                   
DEFAULT_PROFILE = "default"                                                                                                                                                     
AWS_PROFILE_ENV = "AWS_PROFILE"                                                                                                                                                 
AWS_SHARED_CREDENTIALS_ENV = "AWS_SHARED_CREDENTIALS_FILE"                                                                                                                      
DEFAULT_CREDENTIALS_FILE = Path.home() / ".aws" / "credentials"                                                                                                                 
                                                                                                                                                                                
                                                                                                                                                                                
def _is_lambda_environment() -> bool:                                                                                                                                           
    """                                                                                                                                                                         
    Detect if running in AWS Lambda.                                                                                                                                            
                                                                                                                                                                                
    Lambda sets these reserved environment variables automatically:                                                                                                             
    - AWS_EXECUTION_ENV: e.g., "AWS_Lambda_python3.12"                                                                                                                          
    - LAMBDA_TASK_ROOT: e.g., "/var/task"                                                                                                                                       
    - AWS_LAMBDA_FUNCTION_NAME: The function name                                                                                                                               
                                                                                                                                                                                
    Returns:                                                                                                                                                                    
        True if running in Lambda, False otherwise                                                                                                                              
    """                                                                                                                                                                         
    is_lambda = (                                                                                                                                                               
        "AWS_EXECUTION_ENV" in os.environ                                                                                                                                       
        or "LAMBDA_TASK_ROOT" in os.environ                                                                                                                                     
        or "AWS_LAMBDA_FUNCTION_NAME" in os.environ                                                                                                                             
    )                                                                                                                                                                           
                                                                                                                                                                                
    if is_lambda:                                                                                                                                                               
        logger.debug(                                                                                                                                                           
            "Lambda environment detected | "                                                                                                                                    
            f"AWS_EXECUTION_ENV={os.environ.get('AWS_EXECUTION_ENV', 'not set')} | "                                                                                            
            f"AWS_LAMBDA_FUNCTION_NAME={os.environ.get('AWS_LAMBDA_FUNCTION_NAME', 'not set')}"                                                                                 
        )                                                                                                                                                                       
                                                                                                                                                                                
    return is_lambda                                                                                                                                                            
                                                                                                                                                                                
                                                                                                                                                                                
def get_or_refresh_session(profile: Optional[str] = None) -> boto3.Session:                                                                                                     
    """                                                                                                                                                                         
    Create a boto3 session with appropriate credential source.                                                                                                                  
                                                                                                                                                                                
    Credential source selection:                                                                                                                                                
    1. Lambda environment -> Uses IAM role (boto3 default credential chain)                                                                                                     
    2. Credentials file exists -> Reads fresh credentials from file                                                                                                             
    3. Otherwise -> Uses boto3 default (env vars, instance profile, etc.)                                                                                                       
                                                                                                                                                                                
    Args:                                                                                                                                                                       
        profile: Optional AWS profile name to use from credentials file.                                                                                                        
                Defaults to AWS_PROFILE env var or "default".                                                                                                                  
                                                                                                                                                                                
    Returns:                                                                                                                                                                    
        boto3.Session configured with appropriate credentials                                                                                                                   
    """                                                                                                                                                                         
    credentials_file = Path(                                                                                                                                                    
        os.getenv(AWS_SHARED_CREDENTIALS_ENV, DEFAULT_CREDENTIALS_FILE)                                                                                                         
    )                                                                                                                                                                           
                                                                                                                                                                                
    is_lambda = _is_lambda_environment()                                                                                                                                        
    file_exists = credentials_file.exists()                                                                                                                                     
                                                                                                                                                                                
    logger.info(                                                                                                                                                                
        f"Creating boto3 session | "                                                                                                                                            
        f"is_lambda={is_lambda} | "                                                                                                                                             
        f"credentials_file_exists={file_exists} | "                                                                                                                             
        f"credentials_file_path={credentials_file}"                                                                                                                             
    )                                                                                                                                                                           
                                                                                                                                                                                
    # Determine which credential source to use                                                                                                                                  
    # Use boto3 default credential chain if:                                                                                                                                    
    # 1. Running in Lambda (uses IAM role automatically), OR                                                                                                                    
    # 2. Credentials file doesn't exist (e.g., local dev with env vars)                                                                                                         
    use_default_chain = is_lambda or not file_exists                                                                                                                            
                                                                                                                                                                                
    if use_default_chain:                                                                                                                                                       
        # Lambda/IAM role path - boto3 auto-discovers credentials                                                                                                               
        logger.info(                                                                                                                                                            
            f"Using boto3 default credential chain | "                                                                                                                          
            f"reason={'Lambda environment' if is_lambda else 'credentials file not found'}"                                                                                     
        )                                                                                                                                                                       
        session_kwargs: Dict[str, str] = {}                                                                                                                                     
    else:                                                                                                                                                                       
        # Hetzner/K8s path - read fresh credentials from file                                                                                                                   
        logger.info(                                                                                                                                                            
            f"Reading credentials from file | "                                                                                                                                 
            f"file={credentials_file} | "                                                                                                                                       
            f"profile={profile or os.getenv(AWS_PROFILE_ENV, DEFAULT_PROFILE)}"                                                                                                 
        )                                                                                                                                                                       
        try:                                                                                                                                                                    
            credentials = _load_credentials_from_file(profile=profile)                                                                                                          
            session_kwargs = {**credentials}                                                                                                                                    
            logger.info("Successfully loaded credentials from file")                                                                                                            
        except (FileNotFoundError, ValueError) as e:                                                                                                                            
            logger.error(f"Failed to load credentials from file: {e}")                                                                                                          
            raise                                                                                                                                                               
                                                                                                                                                                                
    # Add region if specified                                                                                                                                                   
    region_name = os.getenv("AWS_REGION")                                                                                                                                       
    if region_name:                                                                                                                                                             
        session_kwargs["region_name"] = region_name                                                                                                                             
        logger.debug(f"Using AWS region: {region_name}")                                                                                                                        
                                                                                                                                                                                
    session = boto3.Session(**session_kwargs)                                                                                                                                   
    logger.info(                                                                                                                                                                
        f"boto3 session created successfully | "                                                                                                                                
        f"region={session.region_name}"                                                                                                                                         
    )                                                                                                                                                                           
                                                                                                                                                                                
    return session                                                                                                                                                              
                                                                                                                                                                                
                                                                                                                                                                                
def _load_credentials_from_file(profile: Optional[str] = None) -> Dict[str, str]:                                                                                               
    """                                                                                                                                                                         
    Load AWS credentials from ~/.aws/credentials file.                                                                                                                          
                                                                                                                                                                                
    Args:                                                                                                                                                                       
        profile: AWS profile name to use. Defaults to AWS_PROFILE env var or "default".                                                                                         
                                                                                                                                                                                
    Returns:                                                                                                                                                                    
        Dictionary with aws_access_key_id, aws_secret_access_key,                                                                                                               
        and optionally aws_session_token                                                                                                                                        
                                                                                                                                                                                
    Raises:                                                                                                                                                                     
        FileNotFoundError: If credentials file doesn't exist                                                                                                                    
        ValueError: If profile not found or credentials incomplete                                                                                                              
    """                                                                                                                                                                         
    profile_name = profile or os.getenv(AWS_PROFILE_ENV, DEFAULT_PROFILE)                                                                                                       
    credentials_file = Path(                                                                                                                                                    
        os.getenv(AWS_SHARED_CREDENTIALS_ENV, DEFAULT_CREDENTIALS_FILE)                                                                                                         
    )                                                                                                                                                                           
                                                                                                                                                                                
    logger.debug(                                                                                                                                                               
        f"Loading credentials from file | "                                                                                                                                     
        f"file={credentials_file} | "                                                                                                                                           
        f"profile={profile_name}"                                                                                                                                               
    )                                                                                                                                                                           
                                                                                                                                                                                
    if not credentials_file.exists():                                                                                                                                           
        raise FileNotFoundError(                                                                                                                                                
            f"AWS credentials file not found at '{credentials_file}'."                                                                                                          
        )                                                                                                                                                                       
                                                                                                                                                                                
    parser = configparser.RawConfigParser()                                                                                                                                     
    parser.read(credentials_file)                                                                                                                                               
                                                                                                                                                                                
    if profile_name not in parser:                                                                                                                                              
        available_profiles = list(parser.sections())                                                                                                                            
        raise ValueError(                                                                                                                                                       
            f"Profile '{profile_name}' was not found in {credentials_file}. "                                                                                                   
            f"Available profiles: {available_profiles}"                                                                                                                         
        )                                                                                                                                                                       
                                                                                                                                                                                
    section = parser[profile_name]                                                                                                                                              
    credentials: Dict[str, str] = {                                                                                                                                             
        "aws_access_key_id": section.get("aws_access_key_id", "").strip(),                                                                                                      
        "aws_secret_access_key": section.get("aws_secret_access_key", "").strip(),                                                                                              
    }                                                                                                                                                                           
                                                                                                                                                                                
    if not credentials["aws_access_key_id"] or not credentials["aws_secret_access_key"]:                                                                                        
        raise ValueError(                                                                                                                                                       
            f"Incomplete credentials for profile '{profile_name}' in {credentials_file}. "                                                                                      
            "Both aws_access_key_id and aws_secret_access_key are required."                                                                                                    
        )                                                                                                                                                                       
                                                                                                                                                                                
    # Include session token if present (for temporary credentials)                                                                                                              
    session_token = section.get("aws_session_token", "").strip()                                                                                                                
    if session_token:                                                                                                                                                           
        credentials["aws_session_token"] = session_token                                                                                                                        
        logger.debug("Session token found in credentials file")                                                                                                                 
                                                                                                                                                                                
    logger.debug(                                                                                                                                                               
        f"Credentials loaded | "                                                                                                                                                
        f"access_key_id={credentials['aws_access_key_id'][:8]}*** | "                                                                                                           
        f"has_session_token={bool(session_token)}"                                                                                                                              
    )                                                                                                                                                                           
                                                                                                                                                                                
    return credentials