from ragent.aws.database_conn import conn
from ragent.log_utils import logger


def get_collection_uuid_by_name(collection_name, conversation_id):
    try:
        # Connect to the PostgreSQL database
        with conn.cursor() as cursor:
            # Execute the query
            query = "SELECT uuid FROM langchain_pg_collection WHERE name = %s"
            cursor.execute(query, (collection_name,))

            # Fetch the result
            result = cursor.fetchone()

            # Return the UUID if found
            if result:
                uuid = result[0]
                logger.info(f"The UUID for name '{collection_name}' is: {uuid}")
                update_query = """
                    UPDATE conversation
                    SET uuid = %s
                    WHERE id = %s
                    """
                cursor.execute(update_query, (uuid, conversation_id))

                conn.commit()
                logger.info(
                    f"UUID updated for conversation ID: {uuid}, conversation_id: {conversation_id}"
                )
                return uuid
            else:
                logger.info(f"No UUID found for name '{collection_name}'")
                return None
    except Exception as e:
        logger.info(f"An error occurred: {e}")
