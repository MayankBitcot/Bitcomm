import os

import boto3

from ragent.aws.secrets_manager.envs import get_secret_value_from_secret_manager
from ragent.aws.session import get_or_refresh_session
from ragent.log_utils import logger

# Configuration
TABLE_NAME = get_secret_value_from_secret_manager("DYNAMODB_TABLE_NAME")
REGION_NAME = get_secret_value_from_secret_manager("REGION_NAME")

logger.info(f"DynamoDB configuration - Region: {REGION_NAME}, Table: {TABLE_NAME}")


# Lazy initialization functions to support automatic credential refresh
def get_dynamodb_resource():
    """
    Get a DynamoDB resource with fresh credentials.

    This function creates a new resource on each call with credential caching disabled
    to ensure credentials are always read fresh from the AWS credentials file.
    This is important for scenarios where credentials are frequently updated externally.

    Returns:
        boto3.resource: A DynamoDB resource with fresh, non-cached credentials
    """
    logger.debug(f"Creating DynamoDB resource with region: {REGION_NAME}")

    session = get_or_refresh_session()

    return session.resource("dynamodb", region_name=REGION_NAME)


def get_dynamodb_table(table_name=TABLE_NAME):
    """
    Get a DynamoDB table object with fresh credentials.

    Returns:
        boto3.dynamodb.Table: A DynamoDB table object with current credentials
    """
    dynamodb = get_dynamodb_resource()
    return dynamodb.Table(table_name)


def get_dynamodb_local_table(table_name=TABLE_NAME):
    # Not using get_or_refresh_session() as this function is used only in localhost
    session = boto3.Session()
    return session.resource(
        "dynamodb",
        endpoint_url="http://localhost:8000",
        region_name=os.environ.get("AWS_REGION_LOCAL", "dummy"),
    ).Table(table_name)
