import base64
import hashlib
import hmac

from ragent.aws.cognito.exceptions import CognitoServiceException
from ragent.log_utils import logger


def calculate_secret_hash(email: str, client_id: str, client_secret: str) -> str:
    """
    Compute the SECRET_HASH value required by AWS Cognito.
    """
    try:
        # Log input parameters (safely)
        logger.info("Calculating secret hash for:")
        logger.info(f"- Email: {email}")
        logger.info(f"- Client ID: {client_id}")
        logger.info(
            f"- Client Secret: {'*' * len(client_secret) if client_secret else 'None'}"
        )

        # Validate inputs
        if not email:
            raise ValueError("Email is required")
        if not client_id:
            raise ValueError("Client ID is required")
        if not client_secret:
            raise ValueError("Client Secret is required")

        if not all([email, client_id, client_secret]):
            missing = []
            if not email:
                missing.append("email")
            if not client_id:
                missing.append("client_id")
            if not client_secret:
                missing.append("client_secret")
            error_msg = f"Missing required parameters: {', '.join(missing)}"
            logger.error(error_msg)
            raise ValueError(error_msg)

        message = email + client_id
        dig = hmac.new(
            key=bytes(client_secret, "utf-8"),
            msg=bytes(message, "utf-8"),
            digestmod=hashlib.sha256,
        ).digest()
        hash_value = base64.b64encode(dig).decode()
        logger.info("Successfully calculated secret hash")
        return hash_value
    except Exception as e:
        error_msg = f"Failed to calculate secret hash: {str(e)}"
        logger.error(error_msg)
        raise CognitoServiceException(error_msg)
