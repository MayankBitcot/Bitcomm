from enum import Enum

from ragent.aws.secrets_manager.envs import get_secret_value_from_secret_manager
from ragent.aws.session import get_or_refresh_session
from ragent.log_utils import logger


# AWS Cognito Configuration
class CognitoConfig:
    CLIENT_ID = get_secret_value_from_secret_manager("COGNITO_CLIENT_ID")
    CLIENT_SECRET = get_secret_value_from_secret_manager("COGNITO_CLIENT_SECRET")
    USER_POOL_ID = get_secret_value_from_secret_manager("COGNITO_USER_POOL_ID")

    @staticmethod
    def get_config():
        print("Getting Cognito configuration...")
        client_id = get_secret_value_from_secret_manager("COGNITO_CLIENT_ID")
        print(f"Got COGNITO_CLIENT_ID: {client_id}")

        client_secret = get_secret_value_from_secret_manager("COGNITO_CLIENT_SECRET")
        print(
            f"Got COGNITO_CLIENT_SECRET: {'*' * len(client_secret) if client_secret else None}"
        )

        user_pool_id = get_secret_value_from_secret_manager("COGNITO_USER_POOL_ID")
        print(f"Got COGNITO_USER_POOL_ID: {user_pool_id}")

        region = get_secret_value_from_secret_manager("REGION_NAME")
        print(f"Got REGION_NAME: {region}")

        # Validate all required values are present
        if not all([client_id, client_secret, user_pool_id, region]):
            missing = []
            if not client_id:
                missing.append("COGNITO_CLIENT_ID")
            if not client_secret:
                missing.append("COGNITO_CLIENT_SECRET")
            if not user_pool_id:
                missing.append("COGNITO_USER_POOL_ID")
            if not region:
                missing.append("REGION_NAME")
            error_msg = f"Missing Cognito configuration: {', '.join(missing)}"
            logger.error(error_msg)
            raise ValueError(error_msg)

        return client_id, client_secret, user_pool_id, region

    try:
        logger.info("Initializing CognitoConfig class variables...")
        CLIENT_ID, CLIENT_SECRET, USER_POOL_ID, REGION = get_config()
        logger.info("Successfully initialized CognitoConfig")
    except Exception as e:
        logger.error(f"Failed to get Cognito configuration: {str(e)}")
        raise


# AWS Clients - Lazy initialization to support automatic credential refresh
def get_cognito_client():
    """
    Get a Cognito client with fresh credentials.

    This function creates a new client on each call with credential caching disabled
    to ensure credentials are always read fresh from the AWS credentials file.
    This is important for scenarios where credentials are frequently updated externally.

    Returns:
        boto3.client: A Cognito IDP client with fresh, non-cached credentials
    """
    logger.debug(f"Creating Cognito client with region: {CognitoConfig.REGION}")

    session = get_or_refresh_session()

    cognito_client = session.client("cognito-idp", region_name=CognitoConfig.REGION)

    # Verify the client configuration
    logger.info("Verifying Cognito client configuration...")
    cognito_client.describe_user_pool_client(
        UserPoolId=CognitoConfig.USER_POOL_ID, ClientId=CognitoConfig.CLIENT_ID
    )
    logger.info(f"Successfully verified Cognito client: {CognitoConfig.CLIENT_ID}")
    return cognito_client


# HTTP Status Messages
class StatusMessages:
    SUCCESS = "Operation completed successfully"
    CREATED = "Resource created successfully"
    UPDATED = "Resource updated successfully"
    DELETED = "Resource deleted successfully"


# Error Messages
class ErrorMessages:
    USER_EXIST = "User already exists"
    COGNITO_SERVICE_REQUEST_FAILED = "Cognito service request failed"
    DATABASE_ERROR = "Database operation failed"
    INTERNAL_SERVER_ERROR = "Internal server error occurred"
    VALIDATION_ERROR = "Validation error occurred"
    RESEND_LIMIT = "Resend limit exceeded"
    COGNITO_LOGIN_FAILED = "Cognito login failed"


# Cognito Related Messages
class Cognito:
    success_message = "User registered successfully"
    confirmation_message = "Please check your email for confirmation code"
    login_success = "Login successful"
    logout_success = "Logout successful"


# Database Configuration
class DatabaseConfig:
    HOST = get_secret_value_from_secret_manager("DATABASE_HOST")
    PORT = get_secret_value_from_secret_manager("DATABASE_PORT")
    NAME = get_secret_value_from_secret_manager("DATABASE_NAME")
    USER = get_secret_value_from_secret_manager("DATABASE_USER")
    PASSWORD = get_secret_value_from_secret_manager("DATABASE_PASS")
    MAX_CONNECTIONS = 100
    TIMEOUT = 30
    POOL_SIZE = 20


# API Response Keys
class ResponseKeys:
    STATUS = "status"
    MESSAGE = "message"
    DATA = "data"
    ERRORS = "errors"


# HTTP Methods
class HTTPMethods(Enum):
    GET = "GET"
    POST = "POST"
    PUT = "PUT"
    DELETE = "DELETE"
    PATCH = "PATCH"
    OPTIONS = "OPTIONS"


# Content Types
class ContentTypes:
    JSON = "application/json"
    FORM = "application/x-www-form-urlencoded"
    MULTIPART = "multipart/form-data"


# Export commonly used constants - using the class references
COGNITO_CLIENT_ID = CognitoConfig.CLIENT_ID
COGNITO_CLIENT_SECRET = CognitoConfig.CLIENT_SECRET
COGNITO_USER_POOL_ID = CognitoConfig.USER_POOL_ID
COGNITO_SERVICE_REQUEST_FAILED = ErrorMessages.COGNITO_SERVICE_REQUEST_FAILED
DATABASE_ERROR = ErrorMessages.DATABASE_ERROR
INTERNAL_SERVER_ERROR = ErrorMessages.INTERNAL_SERVER_ERROR
RESESND_LIMIT = ErrorMessages.RESEND_LIMIT
USER_EXIST = ErrorMessages.USER_EXIST
VALIDATION_ERROR = ErrorMessages.VALIDATION_ERROR
COGNITO_LOGIN_FAILED = ErrorMessages.COGNITO_LOGIN_FAILED


# Log Messages
class LogMessages:
    REQUEST_BODY_MISSING = "Request body missing"
    NO_MESSAGES_IN_RESULT = "No messages in result"
    FAILED_STORE_CONVERSATION = "Failed to store conversation"
    NO_RESPONSE_GENERATED = "No response generated"
    LAMBDA_HANDLER_INVOKED = "Lambda handler invoked for login"
