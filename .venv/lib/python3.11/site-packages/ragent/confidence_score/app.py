from typing import Any, List, Optional

from langchain_core.prompts import PromptTemplate
from langchain_openai.chat_models import ChatOpenAI
from pydantic import BaseModel, Field

from ragent.log_utils import logger


class ConfidenceScore(BaseModel):
    confidence_score: str = Field(
        description="The confidence score in percentage between 0 and 100 (e.g. 80%)"
    )
    explanation: str = Field(
        description="Brief explanation for the confidence score",
    )


class ConfidenceScoreManager:
    """
    A class to handle confidence score generation for RAG responses.
    """

    def __init__(self, confidence_score_prompt: str, model: str):
        """
        Initialize the ConfidenceScoreManager.

        Args:
            confidence_score_prompt (str): The prompt template for confidence scoring
            model (str): The model to use for confidence scoring
        """
        self.confidence_score_prompt = confidence_score_prompt
        self.model = model

    def get_confidence_score(
        self, user_input: str, response: str, source_documents: List[Any]
    ) -> Optional[ConfidenceScore]:
        """
        Generate a confidence score for the given response based on the query and source documents.

        Args:
            user_input (str): The original user query
            response (str): The generated response
            source_documents (List[Any]): The source documents used for response generation

        Returns:
            Optional[ConfidenceScore]: The confidence score object or None if an error occurs
        """
        try:
            confidence_prompt = PromptTemplate(
                input_variables=["query_text", "response_text", "context_text"],
                template=self.confidence_score_prompt,
            )
            llm = ChatOpenAI(model=self.model, temperature=0).with_structured_output(
                ConfidenceScore
            )
            chain = confidence_prompt | llm

            context = ""
            if source_documents:
                context = "\n\n".join(
                    [
                        doc.page_content
                        for doc in source_documents
                        if getattr(doc, "page_content", None)
                    ]
                )

            # Use the chain to generate a confidence score
            chain_response = chain.invoke(
                {
                    "query_text": user_input,
                    "response_text": response,
                    "context_text": context,
                }
            )

            return chain_response

        except Exception as e:
            logger.error(f"Error generating confidence score: {e}")
            return None
